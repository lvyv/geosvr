/* (c) 2021 Open Source Geospatial Foundation - all rights reserved
 * This code is licensed under the GPL 2.0 license, available at the root
 * application directory.
 * Copyright © 2019 World Wide Web Consortium, (Massachusetts Institute of Technology, 
 * European Research Consortium for Informatics and Mathematics, Keio    
 * University, Beihang). All Rights Reserved. This work is distributed under the 
 * W3C® Software License [1] in the hope that it will be useful, but WITHOUT ANY 
 * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR 
 * A PARTICULAR PURPOSE.
 * [1] http://www.w3.org/Consortium/Legal/copyright-software
 * 
 */
/*! web-map-custom-element 09-03-2021 */
function(){"use strict";var t=L.GridLayer.extend({initialize:function(t){this.zoomBounds=this._getZoomBounds(t.tileContainer,t.maxZoomBound),L.extend(t,this.zoomBounds),L.setOptions(this,t),this._groups=this._groupTiles(this.options.tileContainer.getElementsByTagName("tile"))},onAdd:function(){this._bounds=this._getLayerBounds(this._groups,this._map.options.projection),this.layerBounds=this._bounds[Object.keys(this._bounds)[0]];for(let t of Object.keys(this._bounds))this.layerBounds.extend(this._bounds[t].min),this.layerBounds.extend(this._bounds[t].max);L.GridLayer.prototype.onAdd.call(this,this._map),this._handleMoveEnd()},getEvents:function(){let t=L.GridLayer.prototype.getEvents.call(this,this._map);return this._parentOnMoveEnd=t.moveend,t.moveend=this._handleMoveEnd,t.move=(()=>{}),t},_handleMoveEnd:function(t){let e=this._map.getZoom(),o=e;o=(o=o>this.options.maxNativeZoom?this.options.maxNativeZoom:o)<this.options.minNativeZoom?this.options.minNativeZoom:o,this.isVisible=e<=this.zoomBounds.maxZoom&&e>=this.zoomBounds.minZoom&&this._bounds[o]&&this._bounds[o].overlaps(M.pixelToPCRSBounds(this._map.getPixelBounds(),this._map.getZoom(),this._map.options.projection)),this.isVisible&&this._parentOnMoveEnd()},_isValidTile(t){return this._groups[this._tileCoordsToKey(t)]},createTile:function(t){let e=this._groups[this._tileCoordsToKey(t)]||[],o=document.createElement("tile");o.setAttribute("col",t.x),o.setAttribute("row",t.y),o.setAttribute("zoom",t.z);for(let t=0;t<e.length;t++){let i=document.createElement("img");i.src=e[t].src,o.appendChild(i)}return o},_getLayerBounds:function(t,e){let o={},i=M[e].options.crs.tile.bounds.max.x;for(let e in t){let t=e.split(":"),n={};n.x=+t[0]*i,n.y=+t[1]*i,n.z=+t[2],t[2]in o?(o[t[2]].extend(L.point(n.x,n.y)),o[t[2]].extend(L.point(n.x+i,n.y+i))):o[t[2]]=L.bounds(L.point(n.x,n.y),L.point(n.x+i,n.y+i))}for(let t in o){let i=+t;o[t]=M.pixelToPCRSBounds(o[t],i,e)}return o},_getZoomBounds:function(t,e){if(!t)return null;let o=M.metaContentToObject(t.getElementsByTagName("tiles")[0].getAttribute("zoom")),i={},n=t.getElementsByTagName("tile");i.nativeZoom=+o.value||0,i.maxNativeZoom=0,i.minNativeZoom=e;for(let t=0;t<n.length;t++){let e=+n[t].getAttribute("zoom");n[t].getAttribute("zoom")||(e=i.nativeZoom),i.minNativeZoom=Math.min(i.minNativeZoom,e),i.maxNativeZoom=Math.max(i.maxNativeZoom,e)}return i.minZoom=i.minNativeZoom-2<=0?0:i.minNativeZoom-2,i.maxZoom=e,o.min&&(i.minZoom=+o.min<i.minNativeZoom-2?i.minNativeZoom-2:+o.min),o.max&&(i.maxZoom=+o.max),i},_groupTiles:function(t){let e={};for(let o=0;o<t.length;o++){let i={};i.row=+t[o].getAttribute("row"),i.col=+t[o].getAttribute("col"),i.zoom=+t[o].getAttribute("zoom")||this.options.nativeZoom,i.src=t[o].getAttribute("src");let n=i.col+":"+i.row+":"+i.zoom;n in e?e[n].push(i):e[n]=[i]}return e}}),e=function(e){return new t(e)},o=L.Control.Layers.extend({options:{autoZIndex:!1,sortLayers:!0,sortFunction:function(t,e){return t.options.zIndex<e.options.zIndex?-1:t.options.zIndex>e.options.zIndex?1:0}},initialize:function(t,e){for(var o in L.setOptions(this,e),this._layerControlInputs=[],this._layers=[],this._lastZIndex=0,this._handlingClick=!1,t)this._addLayer(t[o],o,!0)},onAdd:function(){return this._initLayout(),this._map.on("validate",this._validateInput,this),L.DomEvent.on(this.options.mapEl,"layerchange",this._validateInput,this),this._update(),this._layers.length<1&&!this._map._showControls?this._container.setAttribute("hidden",""):this._map._showControls=!0,this._container},onRemove:function(t){t.off("validate",this._validateInput,this);for(var e=0;e<this._layers.length;e++)this._layers[e].layer.off("add remove",this._onLayerChange,this),this._layers[e].layer.off("extentload",this._validateInput,this)},addOrUpdateOverlay:function(t,e){for(var o=!1,i=0;i<this._layers.length;i++)if(this._layers[i].layer===t){o=!0,this._layers[i].name=e;break}return o||this.addOverlay(t,e),this._layers.length>0&&(this._container.removeAttribute("hidden"),this._map._showControls=!0),this._map?this._update():this},removeLayer:function(t){L.Control.Layers.prototype.removeLayer.call(this,t),0===this._layers.length&&this._container.setAttribute("hidden","")},_validateInput:function(t){for(let t=0;t<this._layers.length;t++){if(!this._layers[t].input.labels[0])continue;let e=this._layers[t].input.labels[0].getElementsByTagName("span"),o=this._layers[t].input.labels[0].getElementsByTagName("input");o[0].checked=this._layers[t].layer._layerEl.checked,this._layers[t].layer._layerEl.disabled&&this._layers[t].layer._layerEl.checked?(o[0].closest("fieldset").disabled=!0,e[0].style.fontStyle="italic"):(o[0].closest("fieldset").disabled=!1,e[0].style.fontStyle="normal")}},_withinZoomBounds:function(t,e){return e.min<=t&&t<=e.max},_addItem:function(t){var e=t.layer.getLayerUserControlsHTML();return t.input=e.querySelector("input"),this._layerControlInputs.push(t.input),t.input.layerId=L.stamp(t.layer),L.DomEvent.on(t.input,"click",this._onInputClick,this),t.layer.on("extentload",this._validateInput,this),this._overlaysList.appendChild(e),e},collapse:function(t){return t.relatedTarget&&t.relatedTarget.parentElement&&("mapml-contextmenu mapml-layer-menu"===t.relatedTarget.className||"mapml-contextmenu mapml-layer-menu"===t.relatedTarget.parentElement.className)||this._map&&"block"===this._map.contextMenu._layerMenu.style.display?this:(L.DomUtil.removeClass(this._container,"leaflet-control-layers-expanded"),this)}}),i=function(t,e){return new o(t,e)};const n="OSMTILE",a="mapmltemplatedtileplaceholder";var s=L.FeatureGroup.extend({initialize:function(t,e){if(L.setOptions(this,e),this._container=L.DomUtil.create("div","leaflet-layer",this.options.pane),L.DomUtil.addClass(this._container,"leaflet-pane mapml-vector-container"),L.DomUtil.create("style","mapml-feature-animation",this._container).innerHTML="@keyframes pathSelect {\n        0% {stroke: white;}\n        50% {stroke: black;}\n      }\n      \n      .mapml-path-selected {\n        animation-name: pathSelect;\n        animation-duration: 1s;\n        stroke-width: 5;\n        stroke: black;\n      }",L.setOptions(this.options.renderer,{pane:this._container}),this._layers={},this.options.query){this._mapmlFeatures=t,this.isVisible=!0;let e=this._getNativeVariables(t);this.options.nativeZoom=e.zoom,this.options.nativeCS=e.cs}if(t&&!this.options.query){let e=this._getNativeVariables(t);!t.querySelector("extent")&&t.querySelector("feature")&&(this._features={},this._staticFeature=!0,this.isVisible=!0,this.zoomBounds=this._getZoomBounds(t,e.zoom),this.layerBounds=this._getLayerBounds(t),L.extend(this.options,this.zoomBounds)),this.addData(t,e.cs,e.zoom),this._staticFeature&&(this._resetFeatures(this._clampZoom(this.options._leafletLayer._map.getZoom())),this.options._leafletLayer._map._addZoomLimit(this))}},onAdd:function(t){L.FeatureGroup.prototype.onAdd.call(this,t),this._mapmlFeatures&&t.on("featurepagination",this.showPaginationFeature,this),this._updateTabIndex()},onRemove:function(t){this._mapmlFeatures&&(t.off("featurepagination",this.showPaginationFeature,this),delete this._mapmlFeatures,L.DomUtil.remove(this._container)),L.FeatureGroup.prototype.onRemove.call(this,t)},getEvents:function(){return this._staticFeature?{moveend:this._handleMoveEnd,zoomend:this._handleZoomEnd}:{moveend:this._removeCSS}},_updateTabIndex:function(){for(let t in this._features)for(let e of this._features[t])e._path&&("M0 0"!==e._path.getAttribute("d")?e._path.setAttribute("tabindex",0):e._path.removeAttribute("tabindex"),e._path.setAttribute("aria-label",e.accessibleTitle),e._path.setAttribute("aria-expanded","false"),L.DomEvent.on(e._path,"keyup keydown",t=>{9!==t.keyCode&&16!==t.keyCode&&13!==t.keyCode||"keyup"!==t.type?(e._path.classList.remove("mapml-path-selected"),e.closeTooltip()):(e._path.classList.add("mapml-path-selected"),e.openTooltip())}),e._path.classList.remove("mapml-path-selected"),e.isTooltipOpen()&&e.closeTooltip())},showPaginationFeature:function(t){if(this.options.query&&this._mapmlFeatures.querySelectorAll("feature")[t.i]){let e=this._mapmlFeatures.querySelectorAll("feature")[t.i];this.clearLayers(),this.addData(e,this.options.nativeCS,this.options.nativeZoom),t.popup._navigationBar.querySelector("p").innerText=t.i+1+"/"+this.options._leafletLayer._totalFeatureCount,t.popup._content.querySelector("iframe").srcdoc='<meta http-equiv="content-security-policy" content="script-src \'none\';">'+e.querySelector("properties").innerHTML}},_previousFeature:function(t){let e=this._source._path.previousSibling;if(!e){let t=this._source._path.closest("div.mapml-layer").style.zIndex,o=this._map.getPane("overlayPane").children;for(let i=o.length-1;i>=0;i--){let n=o[i];if(!(n.style.zIndex>=t)&&(e=n.querySelector("path"))){e=e.parentNode.lastChild;break}}e||(e=this._source._path)}e.focus(),this._map._targets[e._leaflet_id].openTooltip(),this._map.closePopup()},_nextFeature:function(t){let e=this._source._path.nextSibling;if(!e){let t=this._source._path.closest("div.mapml-layer").style.zIndex;for(let o of this._map.getPane("overlayPane").children)if(!(o.style.zIndex<=t)&&(e=o.querySelector("path")))break;e||(e=this._source._path)}e.focus(),this._map._targets[e._leaflet_id].openTooltip(),this._map.closePopup()},_getNativeVariables:function(t){return{zoom:t.querySelector("meta[name=zoom]")&&+M.metaContentToObject(t.querySelector("meta[name=zoom]").getAttribute("content")).value||0,cs:t.querySelector("meta[name=cs]")&&M.metaContentToObject(t.querySelector("meta[name=cs]").getAttribute("content")).content||"GCRS"}},_handleMoveEnd:function(){let t=this._map.getZoom(),e=t<=this.zoomBounds.maxZoom&&t>=this.zoomBounds.minZoom;this.isVisible=e&&this._layers&&this.layerBounds&&this.layerBounds.overlaps(M.pixelToPCRSBounds(this._map.getPixelBounds(),t,this._map.options.projection)),this._removeCSS(),this._updateTabIndex()},_handleZoomEnd:function(t){let e=this._map.getZoom();if(e>this.zoomBounds.maxZoom||e<this.zoomBounds.minZoom)return void this.clearLayers();let o=this._clampZoom(e);this._resetFeatures(o)},_getLayerBounds:function(t){if(!t)return null;let e="TILEMATRIX",o=t.querySelector("meta[name=projection]")&&M.metaContentToObject(t.querySelector("meta[name=projection]").getAttribute("content")).content.toUpperCase()||n;try{let i=t.querySelector("meta[name=extent]")&&M.metaContentToObject(t.querySelector("meta[name=extent]").getAttribute("content")),n=i.zoom||0,a=Object.keys(i);for(let t=0;t<a.length;t++)if(!a[t].includes("zoom")){e=M.axisToCS(a[t].split("-")[2]);break}let s=M.csToAxes(e);return M.boundsToPCRSBounds(L.bounds(L.point(+i[`top-left-${s[0]}`],+i[`top-left-${s[1]}`]),L.point(+i[`bottom-right-${s[0]}`],+i[`bottom-right-${s[1]}`])),n,o,e)}catch(t){return M.boundsToPCRSBounds(M[o].options.crs.tilematrix.bounds(0),0,o,e)}},_resetFeatures:function(t){if(this.clearLayers(),this._features&&this._features[t])for(let e=0;e<this._features[t].length;e++)this.addLayer(this._features[t][e])},_clampZoom:function(t){return t>this.zoomBounds.maxZoom||t<this.zoomBounds.minZoom?t:void 0!==this.zoomBounds.minNativeZoom&&t<this.zoomBounds.minNativeZoom?this.zoomBounds.minNativeZoom:void 0!==this.zoomBounds.maxNativeZoom&&this.zoomBounds.maxNativeZoom<t?this.zoomBounds.maxNativeZoom:t},_setZoomTransform:function(t,e){var o=this._map.getZoomScale(this._map.getZoom(),e),i=t.multiplyBy(o).subtract(this._map._getNewPixelOrigin(t,this._map.getZoom())).round();any3d?L.setTransform(this._layers[e],i,o):L.setPosition(this._layers[e],i)},_getZoomBounds:function(t,e){if(!t)return null;let o,i,a=100,s=0,r=t.getElementsByTagName("feature");for(let t=0;t<r.length;t++){let o=+r[t].getAttribute("zoom");r[t].getAttribute("zoom")||(o=e),s=Math.max(s,o),a=Math.min(a,o)}try{i=M.metaContentToObject(t.querySelector("meta[name=projection]").getAttribute("content")).content,o=M.metaContentToObject(t.querySelector("meta[name=zoom]").getAttribute("content"))}catch(t){return{minZoom:0,maxZoom:M[i||n].options.resolutions.length-1,minNativeZoom:a,maxNativeZoom:s}}return{minZoom:+o.min,maxZoom:+o.max,minNativeZoom:a,maxNativeZoom:s}},addData:function(t,e,o){var i,n,a,s=t.nodeType===Node.DOCUMENT_NODE||"LAYER-"===t.nodeName?t.getElementsByTagName("feature"):null;if(t.nodeType===Node.DOCUMENT_NODE?t.querySelector("link[rel=stylesheet],style"):null){var r=t.querySelector("base")&&t.querySelector("base").hasAttribute("href")?new URL(t.querySelector("base").getAttribute("href")).href:t.URL;M.parseStylesheetAsHTML(t,r,this._container)}if(s){for(i=0,n=s.length;i<n;i++){(a=s[i]).getElementsByTagName("geometry").length&&a.getElementsByTagName("coordinates").length&&this.addData(a,e,o)}return this}var l=this.options;if(l.filter&&!l.filter(t))return;t.classList.length&&(l.className=t.classList.value);let m=t.getAttribute("zoom")||o;var u=this.geometryToLayer(t,l.pointToLayer,l.coordsToLatLng,l,e,+m);if(u){if(u.properties=t.getElementsByTagName("properties")[0],!u.options.color&&t.hasAttribute("class")&&(u.options.className=t.getAttribute("class")),u.defaultOptions=u.options,this.resetStyle(u),l.onEachFeature&&(u.accessibleTitle=t.querySelector("featurecaption"),u.accessibleTitle=u.accessibleTitle?u.accessibleTitle.innerHTML:"Feature",l.onEachFeature(u.properties,u),u.bindTooltip(u.accessibleTitle,{interactive:!0}),u._events&&u._events.keypress.push({ctx:u,fn:this._onSpacePress})),this._staticFeature){let e=t.getAttribute("zoom")||o;return void(e in this._features?this._features[e].push(u):this._features[e]=[u])}return this.addLayer(u)}},resetStyle:function(t){var e=this.options.style;e&&(L.Util.extend(t.options,t.defaultOptions),this._setLayerStyle(t,e))},setStyle:function(t){this.eachLayer(function(e){this._setLayerStyle(e,t)},this)},_setLayerStyle:function(t,e){"function"==typeof e&&(e=e(t.feature)),t.setStyle&&t.setStyle(e)},_removeCSS:function(){let t=this._container.querySelectorAll("link[rel=stylesheet],style");for(let e=0;e<t.length;e++)t[e].classList.contains("mapml-feature-animation")||this._container.removeChild(t[e])},_onSpacePress:function(t){32===t.originalEvent.keyCode&&this._openPopup(t)},geometryToLayer:function(t,e,o,i,n,a){var s,r,l,m,u,c,p="FEATURE"===t.tagName.toUpperCase()?t.getElementsByTagName("geometry")[0]:t;o=o||this.coordsToLatLng;var h=p.getAttribute("cs")||n;switch(p.firstElementChild.tagName.toUpperCase()){case"POINT":return l=[],p.getElementsByTagName("coordinates")[0].textContent.split(/\s+/gim).forEach(M.parseNumber,l),s=o(l,h,a,this.options.projection),e?e(t,s):M.svgMarker(s,i);case"MULTIPOINT":l=[],p.getElementsByTagName("coordinates")[0].textContent.match(/(\S+ \S+)/gim).forEach(M.splitCoordinate,l),r=this.coordsToLatLngs(l,0,o,h,a);var d=new Array(r.length);for(m=0;m<d.length;m++)d[m]=M.svgMarker(r[m],i);return new L.featureGroup(d);case"LINESTRING":return l=[],p.getElementsByTagName("coordinates")[0].textContent.match(/(\S+ \S+)/gim).forEach(M.splitCoordinate,l),r=this.coordsToLatLngs(l,0,o,h,a),new L.Polyline(r,i);case"MULTILINESTRING":for(u=p.getElementsByTagName("coordinates"),c=new Array(u.length),m=0;m<u.length;m++)c[m]=_(u[m]);return r=this.coordsToLatLngs(c,2,o,h,a),new L.Polyline(r,i);case"POLYGON":var y=p.getElementsByTagName("coordinates");return r=this.coordsToLatLngs(_(y),1,o,h,a),new L.Polygon(r,i);case"MULTIPOLYGON":u=p.getElementsByTagName("polygon");var g=new Array(u.length);for(m=0;m<u.length;m++)g[m]=_(u[m].querySelectorAll("coordinates"));return r=this.coordsToLatLngs(g,2,o,h,a),new L.Polygon(r,i);case"GEOMETRYCOLLECTION":console.log("GEOMETRYCOLLECTION Not implemented yet");break;default:console.log("Invalid GeoJSON object.")}function _(t){for(var e=new Array(t.length),o=0;o<e.length;o++)e[o]=[],(t[o]||t).textContent.match(/(\S+\s+\S+)/gim).forEach(M.splitCoordinate,e[o]);return e}},coordsToLatLng:function(t,e,o,i){let n;switch(e.toUpperCase()){case"PCRS":n=t;break;case"TILEMATRIX":let a=t.map(t=>t*M[i].options.crs.tile.bounds.max.x);n=M[i].transformation.untransform(L.point(a),M[i].scale(+o));break;case"TCRS":n=M[i].transformation.untransform(L.point(t),M[i].scale(+o));break;default:return new L.LatLng(t[1],t[0],t[2])}return M[i].unproject(L.point(n),+o)},coordsToLatLngs:function(t,e,o,i,n){var a,s,r,l=[];for(s=0,r=t.length;s<r;s++)a=e?this.coordsToLatLngs(t[s],e-1,o,i,n):(o||this.coordsToLatLng)(t[s],i,n,this.options.projection),l.push(a);return l}}),r=function(t,e){return new s(t,e)},l=L.TileLayer.extend({initialize:function(t,e){let o=M.extractInputBounds(t);this.zoomBounds=o.zoomBounds,this.layerBounds=o.bounds,this.isVisible=!0,L.extend(e,this.zoomBounds),e.tms=t.tms,L.setOptions(this,e),this._setUpTileTemplateVars(t),t.tile.subdomains&&L.setOptions(this,L.extend(this.options,{subdomains:t.tile.subdomains})),this._template=t,this._initContainer(),L.TileLayer.prototype.initialize.call(this,t.template,L.extend(e,{pane:this._container}))},onAdd:function(){this._map._addZoomLimit(this),L.TileLayer.prototype.onAdd.call(this,this._map),this._handleMoveEnd()},getEvents:function(){let t=L.TileLayer.prototype.getEvents.call(this,this._map);return this._parentOnMoveEnd=t.moveend,t.moveend=this._handleMoveEnd,t},_initContainer:function(){this._container||(this._container=L.DomUtil.create("div","leaflet-layer",this.options.pane),L.DomUtil.addClass(this._container,"mapml-templated-tile-container"),this._updateZIndex(),this.options.opacity<1&&this._updateOpacity())},_handleMoveEnd:function(t){let e=this._map.getZoom(),o=M.pixelToPCRSBounds(this._map.getPixelBounds(),e,this._map.options.projection);this.isVisible=e<=this.options.maxZoom&&e>=this.options.minZoom&&this.layerBounds.overlaps(o),this.isVisible&&this._parentOnMoveEnd()},createTile:function(t){let e=document.createElement("DIV"),o=this._map.options.crs.options.crs.tile.bounds.max.x;if(L.DomUtil.addClass(e,"mapml-tile-group"),L.DomUtil.addClass(e,"leaflet-tile"),e.setAttribute("width",`${o}`),e.setAttribute("height",`${o}`),this._template.linkEl.dispatchEvent(new CustomEvent("tileloadstart",{detail:{x:t.x,y:t.y,zoom:t.z,appendTile:t=>{e.appendChild(t)}}})),this._template.type.startsWith("image/"))e.appendChild(L.TileLayer.prototype.createTile.call(this,t,function(){}));else if(!this._url.includes(a)){var i=document.createElementNS("http://www.w3.org/2000/svg","svg");this._fetchTile(t,i),i.setAttribute("width",`${o}`),i.setAttribute("height",`${o}`),L.DomUtil.addClass(i,"leaflet-tile"),e.appendChild(i)}return e},_mapmlTileReady:function(t){L.DomUtil.addClass(t,"leaflet-tile-loaded")},getPane:function(){return this.options.pane},_drawTile:function(t,e,o){if(t.querySelector("link[rel=stylesheet],style")){var i=t.querySelector("base")&&t.querySelector("base").hasAttribute("href")?new URL(t.querySelector("base").getAttribute("href")).href:t.URL;M.parseStylesheetAsHTML(t,i,o)}for(var n=t.querySelectorAll("feature"),a=0;a<n.length;a++)this._draw(n[a],e,o);this._mapmlTileReady(o)},_draw:function(t,e,o){var i,n,a,s="FEATURE"===t.tagName.toUpperCase()?t.getElementsByTagName("geometry")[0]:t,r=this.options.crs;switch(t.classList.add("_"+t.id.substring(t.id.indexOf(".")+1)),t.classList.forEach(t=>s.classList.add(t)),s.firstElementChild.tagName.toUpperCase()){case"POINT":i=[],s.getElementsByTagName("coordinates")[0].textContent.split(/\s+/gim).forEach(M.parseNumber,i),c(this.coordsToPoint(i,e),s);break;case"MULTIPOINT":for(i=[],s.getElementsByTagName("coordinates")[0].textContent.match(/(\S+ \S+)/gim).forEach(M.splitCoordinate,i),a=this.coordsToPoints(i,0,e),n=0;n<a.length;n++){const e=s;t.classList.forEach(t=>e.getElementsByTagName("coordinates")[0].classList.add(t)),c(a[n],e.getElementsByTagName("coordinates")[0])}break;case"LINESTRING":i=[],s.getElementsByTagName("coordinates")[0].textContent.match(/(\S+ \S+)/gim).forEach(M.splitCoordinate,i),u(this.coordsToPoints(i,0,e),s);break;case"MULTILINESTRING":for(a=s.getElementsByTagName("coordinates"),n=0;n<a.length;n++){i=[];const o=a[n];t.classList.forEach(t=>o.classList.add(t)),o.textContent.match(/(\S+ \S+)/gim).forEach(M.splitCoordinate,i),u(this.coordsToPoints(i,0,e),s)}break;case"POLYGON":l(this.coordsToPoints(p(s.getElementsByTagName("coordinates")),1,e),s);break;case"MULTIPOLYGON":for(a=s.getElementsByTagName("polygon"),n=0;n<a.length;n++){const o=a[n];t.classList.forEach(t=>o.classList.add(t)),l(this.coordsToPoints(p(o.getElementsByTagName("coordinates")),1,e),o)}break;case"GEOMETRYCOLLECTION":console.log("GEOMETRYCOLLECTION Not implemented yet");break;default:console.log("Invalid geometry")}function l(t,e){for(var i=document.createElementNS("http://www.w3.org/2000/svg","path"),n="",a=0;a<t.length;a++){n=n+"M "+Math.round(t[a][0].x)+","+Math.round(t[a][0].y)+" ";for(var s=1;s<t[a].length;s++)n=n+Math.round(t[a][s].x)+","+Math.round(t[a][s].y)+" "}(i.setAttribute("d",n),e.classList.forEach(t=>i.classList.add(t)),i.style.display="none",o.appendChild(i),"none"!==window.getComputedStyle(i).stroke)&&(e.querySelector("coordinates span")&&(i.style.stroke="none",function(t,e){for(var o=0;o<t.length;o++){const i=NodeFilter;m(document.createTreeWalker(t[o],i.SHOW_ELEMENT+i.SHOW_TEXT,{acceptNode:function(t){if(t.nodeType===Node.ELEMENT_NODE)return i.FILTER_ACCEPT;return t.nodeType===Node.TEXT_NODE&&/(\S+ \S+)/gim.test(t.data)?i.FILTER_ACCEPT:i.FILTER_REJECT}}),e)}}(e.querySelectorAll("coordinates"),e.classList)));i.style.display=""}function m(t,i){var n,a,s=[];for(n=t.currentNode;n;n=t.nextNode()){const t=n;t.nodeType===Node.TEXT_NODE?s.push(p([t])[0]):i.forEach(e=>t.classList.add(e))}for(t.currentNode=t.root,n=t.currentNode,a=0;n;n=t.nextNode()){var r=t.currentNode;if(n.nodeType===Node.TEXT_NODE){var l=t.parentNode();t.currentNode=r;var m=t.nextNode();t.currentNode=r;var u=t.previousSibling();if(t.currentNode=r,l&&"coordinates"===l.nodeName){if(u&&"span"===u.nodeName){var c=s[a-1].length-1;s[a].unshift(s[a-1][c])}m&&"span"===m.nodeName&&s[a].push(s[a+1][0])}var d=h(s[a],e);const i=document.createElementNS("http://www.w3.org/2000/svg","path");for(var y="M ",g=0;g<d.length;g++)y+=Math.round(d[g].x)+","+Math.round(d[g].y)+" ";i.setAttribute("d",y),l.classList.forEach(t=>i.classList.add(t)),i.classList.add("span"),o.appendChild(i),a++}}}function u(t,e){if(e.querySelector("coordinates span"));else{var i=document.createElementNS("http://www.w3.org/2000/svg","path"),n="";n=n+"M "+Math.round(t[0].x)+","+Math.round(t[0].y)+" ";for(var a=1;a<t.length;a++)n=n+Math.round(t[a].x)+","+Math.round(t[a].y)+" ";i.setAttribute("d",n),e.classList.forEach(t=>i.classList.add(t)),i.classList.add("linestring"),o.appendChild(i)}}function c(t,e){var i=document.createElementNS("http://www.w3.org/2000/svg","circle");i.setAttribute("cx",Math.round(t.x)),i.setAttribute("cy",Math.round(t.y)),i.setAttribute("r","5"),e.classList.forEach(t=>i.classList.add(t)),o.appendChild(i)}function p(t){for(var e=new Array(t.length),o=0;o<e.length;o++)e[o]=[],(t[o]||t).textContent.match(/(\S+\s+\S+)/gim).forEach(M.splitCoordinate,e[o]);return e}function h(t,e){var o,i,n,a=[];for(i=0,n=t.length;i<n;i++)o=d(t[i],e),a.push(o);return a}function d(t,e){return function(t,e){var o=r.transformation.transform(t,r.scale(e.z)),i=r.options.crs.tile.bounds.max.x;return L.point(o.x-e.x*i,o.y-e.y*i)}(L.point(t[0],t[1]),e)}},coordsToLatLng:function(t){return new L.LatLng(t[1],t[0],t[2])},pcrs2tile:function(t,e){var o=this.options.crs,i=o.options.crs.tile.bounds.max.x,n=o.transformation.transform(t,o.scale(e.z));return L.point(n.x-e.x*i,n.y-e.y*i)},coordsToPoint:function(t,e){return this.pcrs2tile(L.point(t[0],t[1]),e)},coordsToPoints:function(t,e,o){var i,n,a,s=[];for(n=0,a=t.length;n<a;n++)i=e?this.coordsToPoints(t[n],e-1,o):this.coordsToPoint(t[n],o),s.push(i);return s},coordsToPointsDBG:function(t,e,o){var i,n,a,s=[];for(n=0,a=t.length;n<a;n++)i=e?this.coordsToPointsDBG(t[n],e-1,o):i=L.point(t[n][0],t[n][1]),s.push(i);return s},_fetchTile:function(t,e){fetch(this.getTileUrl(t),{redirect:"follow"}).then(function(t){return t.status>=200&&t.status<300?Promise.resolve(t):(console.log("Looks like there was a problem. Status Code: "+t.status),Promise.reject(t))}).then(function(t){return t.text()}).then(t=>{return(new DOMParser).parseFromString(t,"application/xml")}).then(o=>{this._drawTile(o,t,e)}).catch(function(t){})},getTileUrl:function(t){if(t.z>=this._template.tilematrix.bounds.length||!this._template.tilematrix.bounds[t.z].contains(t))return"";var e={};for(var o in e[this._template.tilematrix.col.name]=t.x,e[this._template.tilematrix.row.name]=t.y,e[this._template.zoom.name]=this._getZoomForUrl(),e[this._template.pcrs.easting.left]=this._tileMatrixToPCRSPosition(t,"top-left").x,e[this._template.pcrs.easting.right]=this._tileMatrixToPCRSPosition(t,"top-right").x,e[this._template.pcrs.northing.top]=this._tileMatrixToPCRSPosition(t,"top-left").y,e[this._template.pcrs.northing.bottom]=this._tileMatrixToPCRSPosition(t,"bottom-left").y,e[this._template.tile.server]=this._getSubdomain(t),this._template.tile)["row","col","zoom","left","right","top","bottom"].indexOf(o)<0&&(e[o]=this._template.tile[o]);if(this._map&&!this._map.options.crs.infinite){let o=this._globalTileRange.max.y-t.y;this.options.tms&&(e[this._template.tilematrix.row.name]=o)}return e.r=this.options.detectRetina&&L.Browser.retina&&this.options.maxZoom>0?"@2x":"",L.Util.template(this._url,e)},_tileMatrixToPCRSPosition:function(t,e){var o=this._map.options.crs,i=this.getTileSize(),n=t.scaleBy(i),a=n.add(i),s=n.add(Math.floor(i/2)),r=o.transformation.untransform(n,o.scale(t.z)),l=o.transformation.untransform(a,o.scale(t.z)),m=o.transformation.untransform(s,o.scale(t.z)),u=null;switch(e){case"top-left":u=r;break;case"bottom-left":u=new L.Point(r.x,l.y);break;case"center-left":u=new L.Point(r.x,m.y);break;case"top-right":u=new L.Point(l.x,r.y);break;case"bottom-right":u=l;break;case"center-right":u=new L.Point(l.x,m.y);break;case"top-center":u=new L.Point(m.x,r.y);break;case"bottom-center":u=new L.Point(m.x,l.y);break;case"center":u=m}return u},_setUpTileTemplateVars:function(t){t.tile={};for(var e,o,i,n,a,s=t.values,r=this.options.crs.options,l=0;l<t.values.length;l++){var m=s[l].getAttribute("type"),u=s[l].getAttribute("units"),c=s[l].getAttribute("axis"),p=s[l].getAttribute("name"),h=s[l].getAttribute("position"),d="hidden"===m&&s[l].hasAttribute("shard"),y="select"===s[l].tagName.toLowerCase(),g=s[l].getAttribute("value"),_=s[l].getAttribute("min"),f=s[l].getAttribute("max");if("location"===m&&"tilematrix"===u)switch(c){case"column":a={name:p,min:r.crs.tilematrix.horizontal.min,max:r.crs.tilematrix.horizontal.max(r.resolutions.length-1)},isNaN(Number.parseInt(_,10))||(a.min=Number.parseInt(_,10)),isNaN(Number.parseInt(f,10))||(a.max=Number.parseInt(f,10));break;case"row":n={name:p,min:r.crs.tilematrix.vertical.min,max:r.crs.tilematrix.vertical.max(r.resolutions.length-1)},isNaN(Number.parseInt(_,10))||(n.min=Number.parseInt(_,10)),isNaN(Number.parseInt(f,10))||(n.max=Number.parseInt(f,10));break;case"longitude":case"easting":o||(o={min:r.crs.pcrs.horizontal.min,max:r.crs.pcrs.horizontal.max}),isNaN(Number.parseFloat(_))||(o.min=Number.parseFloat(_)),isNaN(Number.parseFloat(f))||(o.max=Number.parseFloat(f)),h&&(h.match(/.*?-left/i)?o.left=p:h.match(/.*?-right/i)&&(o.right=p));break;case"latitude":case"northing":i||(i={min:r.crs.pcrs.vertical.min,max:r.crs.pcrs.vertical.max}),isNaN(Number.parseFloat(_))||(i.min=Number.parseFloat(_)),isNaN(Number.parseFloat(f))||(i.max=Number.parseFloat(f)),h&&(h.match(/top-.*?/i)?i.top=p:h.match(/bottom-.*?/i)&&(i.bottom=p))}else if("zoom"===m.toLowerCase())e={name:p,min:0,max:r.resolutions.length,value:r.resolutions.length},!isNaN(Number.parseInt(g,10))&&Number.parseInt(g,10)>=e.min&&Number.parseInt(g,10)<=e.max?e.value=Number.parseInt(g,10):e.value=e.max,!isNaN(Number.parseInt(_,10))&&Number.parseInt(_,10)>=e.min&&Number.parseInt(_,10)<=e.max&&(e.min=Number.parseInt(_,10)),!isNaN(Number.parseInt(f,10))&&Number.parseInt(f,10)>=e.min&&Number.parseInt(f,10)<=e.max&&(e.max=Number.parseInt(f,10)),t.zoom=e;else if(d)t.tile.server=p,t.tile.subdomains=s[l].servers.slice();else if(y){const e=s[l].htmlselect;t.tile[p]=function(){return e.value}}else{const e=s[l];t.tile[p]=function(){return e.getAttribute("value")}}}var x=this.options.crs.transformation,b=this.options.crs.options.crs.tile.bounds.max.x,v=L.bind(this.options.crs.scale,this.options.crs),E=function(t,e){return x.untransform(t.multiplyBy(b),v(e))},T=function(t,e){return x.transform(t,v(e)).divideBy(b).floor()};o&&i?(t.pcrs={},t.pcrs.bounds=L.bounds([o.min,i.min],[o.max,i.max]),t.pcrs.easting=o,t.pcrs.northing=i):a&&n&&!isNaN(e.value)?(t.pcrs||(t.pcrs={},t.pcrs.easting="",t.pcrs.northing=""),t.pcrs.bounds=L.bounds(E(L.point([a.min,n.min]),e.value),E(L.point([a.max,n.max]),e.value)),t.tilematrix={},t.tilematrix.col=a,t.tilematrix.row=n):console.log("Unable to determine bounds for tile template: "+t.template),t.tilematrix||(t.tilematrix={},t.tilematrix.col={},t.tilematrix.row={}),t.tilematrix.bounds=[];for(var A=t.pcrs.bounds,S=t.zoom?t.zoom.min:0,C=t.zoom?t.zoom.max:r.resolutions.length,M=0;M<=C;M++)t.tilematrix.bounds[M]=M>=S?L.bounds(T(A.min,M),T(A.max,M)):L.bounds(L.point([-1,-1]),L.point([-1,-1]))}}),m=function(t,e){return new l(t,e)},u=L.Layer.extend({initialize:function(t,e){this._templates=t,L.setOptions(this,e),this._container=L.DomUtil.create("div","leaflet-layer",e.pane),L.DomUtil.addClass(this._container,"mapml-templatedlayer-container");for(var o=0;o<t.length;o++)if("tile"===t[o].rel)this._templates[o].layer=M.templatedTileLayer(t[o],L.Util.extend(e,{errorTileUrl:"data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==",zIndex:o,pane:this._container}));else if("image"===t[o].rel)this._templates[o].layer=M.templatedImageLayer(t[o],L.Util.extend(e,{zIndex:o,pane:this._container}));else if("features"===t[o].rel)this._templates[o].layer=M.templatedFeaturesLayer(t[o],L.Util.extend(e,{zIndex:o,pane:this._container}));else if("query"===t[o].rel){this.hasSetBoundsHandler=!0,this._queries||(this._queries=[]);let e=M.extractInputBounds(t[o]);t[o].layerBounds=e.bounds,t[o].zoomBounds=e.zoomBounds,this._queries.push(L.extend(t[o],this._setupQueryVars(t[o])))}},getEvents:function(){return{zoomstart:this._onZoomStart}},redraw:function(){this.closePopup();for(var t=0;t<this._templates.length;t++)"tile"!==this._templates[t].rel&&"image"!==this._templates[t].rel&&"features"!==this._templates[t].rel||this._templates[t].layer.redraw()},_onZoomStart:function(){this.closePopup()},_setupQueryVars:function(t){for(var e={query:{}},o=t.values,i=0;i<t.values.length;i++){var n=o[i].getAttribute("type"),a=o[i].getAttribute("units"),s=o[i].getAttribute("axis"),r=o[i].getAttribute("name"),l=o[i].getAttribute("position"),m=o[i].getAttribute("rel"),u="select"===o[i].tagName.toLowerCase();if("width"===n)e.query.width=r;else if("height"===n)e.query.height=r;else if("location"===n)switch(s){case"x":case"y":case"column":case"row":e.query[s]=r;break;case"longitude":case"easting":l?l.match(/.*?-left/i)?"pixel"===m?e.query.pixelleft=r:"tile"===m?e.query.tileleft=r:e.query.mapleft=r:l.match(/.*?-right/i)&&("pixel"===m?e.query.pixelright=r:"tile"===m?e.query.tileright=r:e.query.mapright=r):e.query[s]=r;break;case"latitude":case"northing":l?l.match(/top-.*?/i)?"pixel"===m?e.query.pixeltop=r:"tile"===m?e.query.tiletop=r:e.query.maptop=r:l.match(/bottom-.*?/i)&&("pixel"===m?e.query.pixelbottom=r:"tile"===m?e.query.tilebottom=r:e.query.mapbottom=r):e.query[s]=r;break;case"i":"tile"===a?e.query.tilei=r:e.query.mapi=r;break;case"j":"tile"===a?e.query.tilej=r:e.query.mapj=r}else if("zoom"===n)e.query.zoom=r;else if(u){const t=o[i].htmlselect;e.query[r]=function(){return t.value}}else{const t=o[i];e.query[r]=function(){return t.getAttribute("value")}}}return e.query.title=t.title,e},reset:function(t){if(t&&this._map){var e=this._map&&this._map.hasLayer(this),o=this._templates;delete this._queries,this._map.off("click",null,this),this._templates=t;for(var i=0;i<t.length;i++)"tile"===t[i].rel?this._templates[i].layer=M.templatedTileLayer(t[i],L.Util.extend(this.options,{errorTileUrl:"data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==",zIndex:i,pane:this._container})):"image"===t[i].rel?this._templates[i].layer=M.templatedImageLayer(t[i],L.Util.extend(this.options,{zIndex:i,pane:this._container})):"features"===t[i].rel?this._templates[i].layer=M.templatedFeaturesLayer(t[i],L.Util.extend(this.options,{zIndex:i,pane:this._container})):"query"===t[i].rel&&(this._queries||(this._queries=[]),this._queries.push(L.extend(t[i],this._setupQueryVars(t[i])))),e&&this.onAdd(this._map);for(i=0;i<o.length;i++)this._map.hasLayer(o[i].layer)&&this._map.removeLayer(o[i].layer)}},onAdd:function(t){for(var e=0;e<this._templates.length;e++)"query"!==this._templates[e].rel&&t.addLayer(this._templates[e].layer)},onRemove:function(t){L.DomUtil.remove(this._container);for(var e=0;e<this._templates.length;e++)"query"!==this._templates[e].rel&&t.removeLayer(this._templates[e].layer)},_previousFeature:function(t){this._count+-1>=0&&(this._count--,this._map.fire("featurepagination",{i:this._count,popup:this}))},_nextFeature:function(t){this._count+1<this._source._totalFeatureCount&&(this._count++,this._map.fire("featurepagination",{i:this._count,popup:this}))}}),c=function(t,e){return new u(t,e)},p=L.Layer.extend({initialize:function(t,e){let o=M.extractInputBounds(t);this.zoomBounds=o.zoomBounds,this.layerBounds=o.bounds,this.isVisible=!0,this._template=t,this._container=L.DomUtil.create("div","leaflet-layer",e.pane),L.extend(e,this.zoomBounds),L.DomUtil.addClass(this._container,"mapml-features-container"),L.setOptions(this,L.extend(e,this._setUpFeaturesTemplateVars(t)))},getEvents:function(){return{moveend:this._onMoveEnd}},onAdd:function(){this._map._addZoomLimit(this);var t,e=new Headers({Accept:"text/mapml"}),o=new DOMParser,i=this.options.opacity,n=this._container,a=this._map;this._features||(this._features=M.mapMlFeatures(null,{renderer:L.svg(),pane:n,opacity:i,imagePath:this.options.imagePath,projection:a.options.projection,onEachFeature:function(t,e){var o=document.createElement("div");o.insertAdjacentHTML("afterbegin",t.innerHTML),e.bindPopup(o,{autoPan:!1,closeButton:!1})}}));var s=this._features,r=function(i,n){return fetch(i,{redirect:"follow",headers:e}).then(function(t){return t.text()}).then(function(e){t=o.parseFromString(e,"application/xml");var a=new URL(t.querySelector("base")?t.querySelector("base").getAttribute("href"):i).href;i=(i=t.querySelector("link[rel=next]")?t.querySelector("link[rel=next]").getAttribute("href"):null)?new URL(i,a).href:null;let l=t.querySelector("meta[name=zoom]")&&+M.metaContentToObject(t.querySelector("meta[name=zoom]").getAttribute("content")).value||0,m=t.querySelector("meta[name=cs]")&&M.metaContentToObject(t.querySelector("meta[name=cs]").getAttribute("content")).content||"GCRS";if(s.addData(t,m,l),i&&--n)return r(i,n)})};r(this._getfeaturesUrl(),10).then(function(){a.addLayer(s),a.fire("moveend")}).catch(function(t){console.log(t)})},_onMoveEnd:function(){let t=this._map.getZoom(),e=M.pixelToPCRSBounds(this._map.getPixelBounds(),t,this._map.options.projection);if(this.isVisible=t<=this.zoomBounds.maxZoom&&t>=this.zoomBounds.minZoom&&this.layerBounds.overlaps(e),this._features.clearLayers(),this.isVisible){var o,i=new Headers({Accept:"text/mapml;q=0.9,application/geo+json;q=0.8"}),n=new DOMParser,a=this._features,s=this._map,r=this,l=function(t,e){return fetch(t,{redirect:"follow",headers:i}).then(function(t){return t.text()}).then(function(i){o=n.parseFromString(i,"application/xml");var s=new URL(o.querySelector("base")?o.querySelector("base").getAttribute("href"):t).href;t=(t=o.querySelector("link[rel=next]")?o.querySelector("link[rel=next]").getAttribute("href"):null)?new URL(t,s).href:null;let r=o.querySelector("meta[name=zoom]")&&+M.metaContentToObject(o.querySelector("meta[name=zoom]").getAttribute("content")).value||0,m=o.querySelector("meta[name=cs]")&&M.metaContentToObject(o.querySelector("meta[name=cs]").getAttribute("content")).content||"GCRS";if(a.addData(o,m,r),t&&--e)return l(t,e)})};l(this._getfeaturesUrl(),10).then(function(){s.addLayer(a),M.TemplatedFeaturesLayer.prototype._updateTabIndex(r)}).catch(function(t){console.log(t)})}},setZIndex:function(t){return this.options.zIndex=t,this._updateZIndex(),this},_updateTabIndex:function(t){let e=t||this;for(let t in e._features._layers){let o=e._features._layers[t];if(o._path&&("M0 0"!==o._path.getAttribute("d")?o._path.setAttribute("tabindex",0):o._path.removeAttribute("tabindex"),0===o._path.childElementCount)){let t=document.createElement("title");t.innerText="Feature",o._path.appendChild(t)}}},_updateZIndex:function(){this._container&&void 0!==this.options.zIndex&&null!==this.options.zIndex&&(this._container.style.zIndex=this.options.zIndex)},onRemove:function(){this._map.removeLayer(this._features)},_getfeaturesUrl:function(){var t=this._map.getPixelBounds(),e=t.getTopLeft(),o=t.getTopRight(),i=t.getBottomRight(),n=t.getBottomLeft(),a=this._map.getBounds();a.extend(this._map.unproject(n)).extend(this._map.unproject(i)).extend(this._map.unproject(e)).extend(this._map.unproject(o));var s={};for(var r in s[this.options.feature.zoom.name]=this._map.getZoom(),s[this.options.feature.bottom.name]=a.getSouth(),s[this.options.feature.left.name]=a.getWest(),s[this.options.feature.top.name]=a.getNorth(),s[this.options.feature.right.name]=a.getEast(),this.options.feature)["width","height","left","right","top","bottom","zoom"].indexOf(r)<0&&(s[r]=this.options.feature[r]);return L.Util.template(this._template.template,s)},_setUpFeaturesTemplateVars:function(t){var e={feature:{}},o=t.values;e.feature.hidden=[];for(var i=0;i<o.length;i++){var n=o[i].getAttribute("type"),a=o[i].getAttribute("units"),s=o[i].getAttribute("axis"),r=o[i].getAttribute("name"),l=o[i].getAttribute("position"),m=o[i].getAttribute("value"),u="select"===o[i].tagName.toLowerCase();if("width"===n)e.feature.width={name:r};else if("height"===n)e.feature.height={name:r};else if("zoom"===n)e.feature.zoom={name:r};else if("location"!==n||"pcrs"!==a&&"gcrs"!==a&&"tcrs"!==a)if(u){const t=o[i].htmlselect;e.feature[r]=function(){return t.value}}else"hidden"!==n&&"projection"!==n||e.feature.hidden.push({name:r,value:m});else switch(s){case"x":case"longitude":case"easting":l&&(l.match(/.*?-left/i)?e.feature.left={name:r,axis:s}:l.match(/.*?-right/i)&&(e.feature.right={name:r,axis:s}));break;case"y":case"latitude":case"northing":l&&(l.match(/top-.*?/i)?e.feature.top={name:r,axis:s}:l.match(/bottom-.*?/i)&&(e.feature.bottom={name:r,axis:s}))}}return e}}),h=function(t,e){return new p(t,e)},d=L.Layer.extend({initialize:function(t,e){this._template=t,this._container=L.DomUtil.create("div","leaflet-layer",e.pane),L.DomUtil.addClass(this._container,"mapml-image-container");let o=M.extractInputBounds(t);this.zoomBounds=o.zoomBounds,this.layerBounds=o.bounds,this.isVisible=!0,L.extend(e,this.zoomBounds),L.setOptions(this,L.extend(e,this._setUpExtentTemplateVars(t)))},getEvents:function(){return{moveend:this._onMoveEnd}},onAdd:function(){this._map._addZoomLimit(this),this.setZIndex(this.options.zIndex),this._onMoveEnd()},redraw:function(){this._onMoveEnd()},_clearLayer:function(){let t=this._container.querySelectorAll("img");for(let e=0;e<t.length;e++)this._container.removeChild(t[e])},_onMoveEnd:function(){let t=this._map.getZoom(),e=M.pixelToPCRSBounds(this._map.getPixelBounds(),t,this._map.options.projection);if(this.isVisible=t<=this.zoomBounds.maxZoom&&t>=this.zoomBounds.minZoom&&this.layerBounds.overlaps(e),this.isVisible){var o=this._map,i=o.getPixelBounds().min.subtract(o.getPixelOrigin()),n=o.getSize(),a=this.getImageUrl(),s=this._imageOverlay;this._imageOverlay=M.imageOverlay(a,i,n,0,this._container),this._imageOverlay.addTo(o),s&&this._imageOverlay.on("load error",function(){o.removeLayer(s)})}else this._clearLayer()},setZIndex:function(t){return this.options.zIndex=t,this._updateZIndex(),this},_updateZIndex:function(){this._container&&void 0!==this.options.zIndex&&null!==this.options.zIndex&&(this._container.style.zIndex=this.options.zIndex)},onRemove:function(t){this._clearLayer(),t._removeZoomLimit(this),this._container=null},getImageUrl:function(){var t={};for(var e in t[this.options.extent.width]=this._map.getSize().x,t[this.options.extent.height]=this._map.getSize().y,t[this.options.extent.bottom]=this._TCRSToPCRS(this._map.getPixelBounds().max,this._map.getZoom()).y,t[this.options.extent.left]=this._TCRSToPCRS(this._map.getPixelBounds().min,this._map.getZoom()).x,t[this.options.extent.top]=this._TCRSToPCRS(this._map.getPixelBounds().min,this._map.getZoom()).y,t[this.options.extent.right]=this._TCRSToPCRS(this._map.getPixelBounds().max,this._map.getZoom()).x,this.options.extent)["width","height","left","right","top","bottom"].indexOf(e)<0&&(t[e]=this.options.extent[e]);return L.Util.template(this._template.template,t)},_TCRSToPCRS:function(t,e){var o=this._map.options.crs;return o.transformation.untransform(t,o.scale(e))},_setUpExtentTemplateVars:function(t){for(var e={extent:{}},o=t.values,i=0;i<t.values.length;i++){var n=o[i].getAttribute("type"),a=o[i].getAttribute("units"),s=o[i].getAttribute("axis"),r=o[i].getAttribute("name"),l=o[i].getAttribute("position"),m="select"===o[i].tagName.toLowerCase();if("width"===n)e.extent.width=r;else if("height"===n)e.extent.height=r;else if("location"!==n||"pcrs"!==a&&"gcrs"!==a)if(m){const t=o[i].htmlselect;e.extent[r]=function(){return t.value}}else{const t=o[i];e.extent[r]=function(){return t.getAttribute("value")}}else switch(s){case"longitude":case"easting":l&&(l.match(/.*?-left/i)?e.extent.left=r:l.match(/.*?-right/i)&&(e.extent.right=r));break;case"latitude":case"northing":l&&(l.match(/top-.*?/i)?e.extent.top=r:l.match(/bottom-.*?/i)&&(e.extent.bottom=r))}}return e}}),y=function(t,e){return new d(t,e)},g=L.ImageOverlay.extend({initialize:function(t,e,o,i,n,a){this._container=n,this._url=t,this._location=e,this._size=L.point(o),this._angle=i,L.setOptions(this,a)},getEvents:function(){var t={viewreset:this._reset};return this._zoomAnimated&&(t.zoomanim=this._animateZoom),t},onAdd:function(){this.on({load:this._onImageLoad}),this._image||this._initImage(),this.options.interactive&&(L.DomUtil.addClass(this._image,"leaflet-interactive"),this.addInteractiveTarget(this._image)),this._container.appendChild(this._image),this._reset()},onRemove:function(){L.DomUtil.remove(this._image),this.options.interactive&&this.removeInteractiveTarget(this._image)},_onImageLoad:function(){this._image&&(this._image.loaded=+new Date,this._updateOpacity())},_animateZoom:function(t){var e=this._map.getZoomScale(t.zoom),o=this._map.getPixelOrigin().add(this._location).multiplyBy(e).subtract(this._map._getNewPixelOrigin(t.center,t.zoom)).round();L.Browser.any3d?L.DomUtil.setTransform(this._image,o,e):L.DomUtil.setPosition(this._image,o)},_reset:function(){var t=this._image,e=this._location,o=this._size;L.DomUtil.setPosition(t,e),t.style.width=o.x+"px",t.style.height=o.y+"px"},_updateOpacity:function(){if(this._map){var t=+new Date,e=!1,o=this._image,i=Math.min(1,(t-o.loaded)/200);L.DomUtil.setOpacity(o,i),i<1&&(e=!0),e&&(L.Util.cancelAnimFrame(this._fadeFrame),this._fadeFrame=L.Util.requestAnimFrame(this._updateOpacity,this)),L.DomUtil.addClass(o,"leaflet-image-loaded")}}}),_=function(t,e,o,i,n,a){return new g(t,e,o,i,n,a)},f=L.Layer.extend({options:{maxNext:10,zIndex:0,maxZoom:25},initialize:function(t,e,o){var i;t&&(this._href=t),e&&(this._layerEl=e,i=!!e.querySelector("image,feature,tile,extent"),!t&&i&&(this._content=e)),L.setOptions(this,o),this._container=L.DomUtil.create("div","leaflet-layer"),L.DomUtil.addClass(this._container,"mapml-layer"),this._imageContainer=L.DomUtil.create("div","leaflet-layer",this._container),L.DomUtil.addClass(this._imageContainer,"mapml-image-container"),this._mapmlTileContainer=L.DomUtil.create("div","mapml-tile-container",this._container),this._initCount=0,this._initExtent(i?e:null),this.on("attached",this._validateExtent,this),this.validProjection=!0},setZIndex:function(t){return this.options.zIndex=t,this._updateZIndex(),this},_updateZIndex:function(){this._container&&void 0!==this.options.zIndex&&null!==this.options.zIndex&&(this._container.style.zIndex=this.options.zIndex)},_changeOpacity:function(t){t&&t.target&&t.target.value>=0&&t.target.value<=1&&this.changeOpacity(t.target.value)},changeOpacity:function(t){this._container.style.opacity=t},onAdd:function(t){!this._extent||this._validProjection(t)?(this._map=t,this._content?(this._mapmlvectors||(this._mapmlvectors=M.mapMlFeatures(this._content,{renderer:L.svg(),pane:this._container,opacity:this.options.opacity,imagePath:M.detectImagePath(this._map.getContainer()),projection:t.options.projection,_leafletLayer:this,onEachFeature:function(t,e){if(t){var o=document.createElement("div");o.classList.add("mapml-popup-content"),o.insertAdjacentHTML("afterbegin",t.innerHTML),e.bindPopup(o,{autoClose:!1,minWidth:108})}}})),t.addLayer(this._mapmlvectors)):this.once("extentload",function(){this._validProjection(t)?(this._mapmlvectors||(this._mapmlvectors=M.mapMlFeatures(this._content,{renderer:L.svg(),pane:this._container,opacity:this.options.opacity,imagePath:M.detectImagePath(this._map.getContainer()),projection:t.options.projection,_leafletLayer:this,onEachFeature:function(t,e){if(t){var o=document.createElement("div");o.classList.add("mapml-popup-content"),o.insertAdjacentHTML("afterbegin",t.innerHTML),e.bindPopup(o,{autoClose:!1,minWidth:108})}}}).addTo(t)),this._setLayerElExtent()):this.validProjection=!1},this),this._imageLayer||(this._imageLayer=L.layerGroup()),t.addLayer(this._imageLayer),(!this._staticTileLayer||null===this._staticTileLayer._container)&&this._mapmlTileContainer.getElementsByTagName("tiles").length>0&&(this._staticTileLayer=M.mapMLStaticTileLayer({pane:this._container,_leafletLayer:this,className:"mapml-static-tile-layer",tileContainer:this._mapmlTileContainer,maxZoomBound:t.options.crs.options.resolutions.length-1,tileSize:t.options.crs.options.crs.tile.bounds.max.x}),t.addLayer(this._staticTileLayer)),this._extent?this._templateVars&&(this._templatedLayer=M.templatedLayer(this._templateVars,{pane:this._container,imagePath:M.detectImagePath(this._map.getContainer()),_leafletLayer:this,crs:this.crs}).addTo(t)):this.once("extentload",function(){this._validProjection(t)?this._templateVars&&(this._templatedLayer=M.templatedLayer(this._templateVars,{pane:this._container,imagePath:M.detectImagePath(this._map.getContainer()),_leafletLayer:this,crs:this.crs}).addTo(t),this._setLayerElExtent()):this.validProjection=!1},this),this._setLayerElExtent(),this.setZIndex(this.options.zIndex),this.getPane().appendChild(this._container),setTimeout(()=>{t.fire("checkdisabled")},0),t.on("popupopen",this._attachSkipButtons,this)):this.validProjection=!1},_validProjection:function(t){let e=!1;if(this._templateVars)for(let t of this._templateVars)t.projectionMatch||(e=!0);return!e&&this.getProjection()===t.options.projection.toUpperCase()},_setLayerElExtent:function(){let t,e;["_staticTileLayer","_imageLayer","_mapmlvectors","_templatedLayer"].forEach(o=>{if(this[o])if("_templatedLayer"===o)for(let i=0;i<this[o]._templates.length;i++)"query"!==this[o]._templates[i].rel&&this[o]._templates[i].layer.layerBounds&&(t?(t.extend(this[o]._templates[i].layer.layerBounds.min),t.extend(this[o]._templates[i].layer.layerBounds.max)):(t=this[o]._templates[i].layer.layerBounds,e=this[o]._templates[i].layer.zoomBounds));else this[o].layerBounds&&(t?(t.extend(this[o].layerBounds.min),t.extend(this[o].layerBounds.max)):(t=this[o].layerBounds,e=this[o].zoomBounds))}),t&&(this._layerEl.extent=Object.assign(M.convertAndFormatPCRS(t,this._map),{zoom:e}))},addTo:function(t){return t.addLayer(this),this},getEvents:function(){return{zoomanim:this._onZoomAnim}},redraw:function(){this._templatedLayer&&this._templatedLayer.redraw()},_onZoomAnim:function(t){var e=t.zoom,o=this._extent?this._extent.querySelector("input[type=zoom]"):null,i=o&&o.hasAttribute("min")?parseInt(o.getAttribute("min")):this._map.getMinZoom(),n=o&&o.hasAttribute("max")?parseInt(o.getAttribute("max")):this._map.getMaxZoom(),a=e<i&&this._extent.zoomout||e>n&&this._extent.zoomin;i<=e&&e<=n||(this._extent.zoomin&&e>n?(this._href=this._extent.zoomin,this.href=this._extent.zoomin):this._extent.zoomout&&e<i&&(this._href=this._extent.zoomout,this.href=this._extent.zoomout)),this._templatedLayer&&a&&this._initExtent()},onRemove:function(t){L.DomUtil.remove(this._container),this._staticTileLayer&&t.removeLayer(this._staticTileLayer),this._mapmlvectors&&t.removeLayer(this._mapmlvectors),t.removeLayer(this._imageLayer),this._templatedLayer&&t.removeLayer(this._templatedLayer),t.fire("checkdisabled"),t.off("popupopen",this._attachSkipButtons)},getZoomBounds:function(){var t=this._extent,e=t?t.querySelector("[type=zoom]"):void 0,o=e&&e.hasAttribute("min")?e.getAttribute("min"):this._map.getMinZoom(),i=e&&e.hasAttribute("max")?e.getAttribute("max"):this._map.getMaxZoom(),n={};return n.min=Math.min(o,i),n.max=Math.max(o,i),n},_transformDeprectatedInput:function(t){var e=t.getAttribute("type").toLowerCase();if("xmin"===e||"ymin"===e||"xmax"===e||"ymax"===e)switch(t.setAttribute("type","location"),t.setAttribute("units","tcrs"),e){case"xmin":t.setAttribute("axis","x"),t.setAttribute("position","top-left");break;case"ymin":t.setAttribute("axis","y"),t.setAttribute("position","top-left");break;case"xmax":t.setAttribute("axis","x"),t.setAttribute("position","bottom-right");break;case"ymax":t.setAttribute("axis","y"),t.setAttribute("position","bottom-right")}},_setUpInputVars:function(t){var e={extent:{}};e.extent.hidden=[];for(var o=0;o<t.length;o++){this._transformDeprectatedInput(t[o]);var i=t[o].getAttribute("type"),n=t[o].getAttribute("units"),a=t[o].getAttribute("axis"),s=t[o].getAttribute("name"),r=t[o].getAttribute("position"),l=t[o].getAttribute("value");if("width"===i)e.extent.width={name:s};else if("height"===i)e.extent.height={name:s};else if("zoom"===i)e.extent.zoom={name:s};else if("location"!==i||"pcrs"!==n&&"gcrs"!==n&&"tcrs"!==n)"hidden"!==i&&"projection"!==i||e.extent.hidden.push({name:s,value:l});else switch(a){case"easting":r&&(r.match(/.*?-left/i)?e.extent.left={name:s,axis:a}:r.match(/.*?-right/i)&&(e.extent.right={name:s,axis:a}));break;case"northing":r&&(r.match(/top-.*?/i)?e.extent.top={name:s,axis:a}:r.match(/bottom-.*?/i)&&(e.extent.bottom={name:s,axis:a}));break;case"x":r&&(r.match(/.*?-left/i)?e.extent.left={name:s,axis:a}:r.match(/.*?-right/i)&&(e.extent.right={name:s,axis:a}));break;case"y":r&&(r.match(/top-.*?/i)?e.extent.top={name:s,axis:a}:r.match(/bottom-.*?/i)&&(e.extent.bottom={name:s,axis:a}));break;case"longitude":r&&(r.match(/.*?-left/i)?e.extent.left={name:s,axis:a}:r.match(/.*?-right/i)&&(e.extent.right={name:s,axis:a}));break;case"latitude":r&&(r.match(/top-.*?/i)?e.extent.top={name:s,axis:a}:r.match(/bottom-.*?/i)&&(e.extent.bottom={name:s,axis:a}))}}return e},getLayerExtentBounds:function(t){if(this._extent){var e,o,i,n,a,s,r,l,m=t.getZoom(),u=t.options.projection,c=u!==this._extent.getAttribute("units");if(s=this._extent.querySelector("[type=xmin]").getAttribute("min"),r=this._extent.querySelector("[type=xmax]").getAttribute("min"),o=Math.min(s,r),s=this._extent.querySelector("[type=xmin]").getAttribute("max"),r=this._extent.querySelector("[type=xmax]").getAttribute("max"),n=Math.max(s,r),s=this._extent.querySelector("[type=ymin]").getAttribute("min"),r=this._extent.querySelector("[type=ymax]").getAttribute("min"),i=Math.min(s,r),s=this._extent.querySelector("[type=ymin]").getAttribute("max"),r=this._extent.querySelector("[type=ymax]").getAttribute("max"),a=Math.max(s,r),c){var p=[(e=M[u]).latLngToPoint(L.latLng([i,o]),m),e.latLngToPoint(L.latLng([a,n]),m),e.latLngToPoint(L.latLng([i,o]),m),e.latLngToPoint(L.latLng([i,n]),m)];return L.bounds(p)}return(l=parseInt(this._extent.querySelector("[type=zoom]").getAttribute("value")))!==m?(e=M[u],L.bounds(e.latLngToPoint(e.pointToLatLng(L.point(o,i),l),m),e.latLngToPoint(e.pointToLatLng(L.point(n,a),l),m))):L.bounds(L.point(o,i),L.point(n,a))}},getAttribution:function(){return this.options.attribution},getLayerUserControlsHTML:function(){var t=document.createElement("fieldset"),e=document.createElement("input"),o=document.createElement("label"),i=document.createElement("span"),n=document.createElement("details"),a=document.createElement("summary"),s=document.createElement("div"),r=document.createElement("input"),l=document.createElement("details"),m=document.createElement("summary"),u=document.createElement("label"),c=this._layerEl.parentNode;a.style.display="flex",a.style.alignItems="center",s.classList.add("mapml-control-summary-container");let p=document.createElement("a");if(p.href="#",p.role="button",p.title="Remove Layer",p.innerHTML="<span aria-hidden='true'>&#10006;</span>",p.classList.add("mapml-layer-remove-button"),L.DomEvent.disableClickPropagation(p),L.DomEvent.on(p,"click",L.DomEvent.stop),L.DomEvent.on(p,"click",t=>{c.removeChild(t.target.closest("fieldset").querySelector("span").layer._layerEl)},this),e.defaultChecked=!!this._map,e.type="checkbox",e.className="leaflet-control-layers-selector",i.layer=this,this._legendUrl){var h=document.createElement("a");h.text=" "+this._title,h.href=this._legendUrl,h.target="_blank",h.draggable=!1,i.appendChild(h)}else i.innerHTML=" "+this._title;if(o.appendChild(e),o.appendChild(i),u.innerText="Opacity",r.id="o"+L.stamp(r),u.setAttribute("for",r.id),m.appendChild(u),l.appendChild(m),l.appendChild(r),L.DomUtil.addClass(n,"mapml-control-layers"),L.DomUtil.addClass(l,"mapml-control-layers"),r.setAttribute("type","range"),r.setAttribute("min","0"),r.setAttribute("max","1.0"),r.setAttribute("value",this._container.style.opacity||"1.0"),r.setAttribute("step","0.1"),r.value=this._container.style.opacity||"1.0",t.setAttribute("aria-grabbed","false"),t.onmousedown=(e=>{if("input"===e.target.tagName.toLowerCase())return;e.preventDefault();let o=t,i=t.parentNode,n=!1,a=e.clientY;document.body.onmousemove=(t=>{t.preventDefault();let e=t.clientY-a;if(n=Math.abs(e)>5||n,i&&!n||i&&i.childElementCount<=1||i.getBoundingClientRect().top>o.getBoundingClientRect().bottom||i.getBoundingClientRect().bottom<o.getBoundingClientRect().top)return;i.classList.add("mapml-draggable"),o.style.transform="translateY("+e+"px)",o.style.pointerEvents="none";let s=t.clientX,r=t.clientY,l=("MAPML-VIEWER"===c.tagName?c.shadowRoot:c.querySelector(".web-map").shadowRoot).elementFromPoint(s,r),m=l&&l.closest("fieldset")?l.closest("fieldset"):o;m=Math.abs(e)<=m.offsetHeight?o:m,o.setAttribute("aria-grabbed","true"),o.setAttribute("aria-dropeffect","move"),m&&i===m.parentNode&&(m=m!==o.nextSibling?m:m.nextSibling,o!==m&&(a=t.clientY,o.style.transform=null),i.insertBefore(o,m))}),document.body.onmouseup=(()=>{o.setAttribute("aria-grabbed","false"),o.removeAttribute("aria-dropeffect"),o.style.pointerEvents=null,o.style.transform=null;let t=i.children,e=1;for(let o of t){let t=o.querySelector("span").layer._layerEl;t.setAttribute("data-moving",""),c.insertAdjacentElement("beforeend",t),t.removeAttribute("data-moving"),t._layer.setZIndex(e),e++}i.classList.remove("mapml-draggable"),document.body.onmousemove=document.body.onmouseup=null})}),L.DomEvent.on(r,"change",this._changeOpacity,this),t.appendChild(n),n.appendChild(a),s.appendChild(o),s.appendChild(p),a.appendChild(s),n.appendChild(l),this._styles&&n.appendChild(this._styles),this._userInputs){var d=document.createDocumentFragment(),y=this._templateVars;if(y)for(var g=0;g<y.length;g++)for(var _=y[g],f=0;f<_.values.length;f++){var x=_.values[f],b="#"+x.getAttribute("id");if("select"===x.tagName.toLowerCase()&&!d.querySelector(b)){var v=document.createElement("fieldset"),E=document.createElement("details"),T=document.createElement("summary"),A=document.createElement("label");A.innerText=x.getAttribute("name"),A.setAttribute("for",x.getAttribute("id")),L.DomUtil.addClass(E,"mapml-control-layers"),T.appendChild(A),E.appendChild(T),E.appendChild(x.htmlselect),v.appendChild(E),d.appendChild(v)}}n.appendChild(d)}return t},_initExtent:function(t){if(this._href||t){var e,o,i=this;if(this._href){var s=new XMLHttpRequest;e=this._href,o=r,s.onreadystatechange=function(){this.readyState===this.DONE&&(400!==this.status&&404!==this.status&&500!==this.status&&406!==this.status||(i.error=!0,i.fire("extentload",i,!0),s.abort()))},s.onload=o,s.onerror=function(){i.error=!0,i.fire("extentload",i,!0)},s.open("GET",e),s.setRequestHeader("Accept",M.mime),s.overrideMimeType("text/xml"),s.send()}else t&&r.call(this,t)}function r(t){var e=this.responseXML||t;if(e.querySelector("feature")&&(i._content=e),!this.responseXML&&this.responseText&&(e=(new DOMParser).parseFromString(this.responseText,"text/xml")),this.readyState===this.DONE&&e.querySelector){var o,s=e.querySelector("extent")||e.querySelector("meta[name=projection]");"extent"===s.tagName.toLowerCase()&&s.hasAttribute("units")?o=s.getAttribute("units"):"meta"===s.tagName.toLowerCase()&&s.hasAttribute("content")&&(o=M.metaContentToObject(s.getAttribute("content")).content);var r=o&&o===i.options.mapprojection,l=e.querySelector("meta[name=extent]"),m=!r&&e.querySelector("head link[rel=alternate][projection="+i.options.mapprojection+"]"),u=new URL(e.querySelector("base")?e.querySelector("base").getAttribute("href"):e.baseURI||this.responseURL,this.responseURL).href;if(s){if(!r&&m&&m.hasAttribute("href"))return void i.fire("changeprojection",{href:new URL(m.getAttribute("href"),u).href},!1);if(s.querySelector("link[rel=tile],link[rel=image],link[rel=features],link[rel=query]")&&s.hasAttribute("units")){i._templateVars=[];var c=s.querySelectorAll("link[rel=tile],link[rel=image],link[rel=features],link[rel=query]"),p=new RegExp("(?:{)(.*?)(?:})","g"),h=s.querySelector('input[type="zoom" i]'),d=!1,y={zoom:0};if(l){let t,e=M.metaContentToObject(l.getAttribute("content"));y.zoom=e.zoom||y.zoom;let i=Object.keys(e);for(let e=0;e<i.length;e++)if(!i[e].includes("zoom")){t=M.axisToCS(i[e].split("-")[2]);break}let n=M.csToAxes(t);y.bounds=M.boundsToPCRSBounds(L.bounds(L.point(+e[`top-left-${n[0]}`],+e[`top-left-${n[1]}`]),L.point(+e[`bottom-right-${n[0]}`],+e[`bottom-right-${n[1]}`])),y.zoom,o,t)}else y.bounds=M[o].options.crs.pcrs.bounds;for(var g=0;g<c.length;g++){var _=c[g],f=_.getAttribute("tref");if(!f){f=a;let t=e.querySelectorAll("input");for(let e of t)f+=`{${e.getAttribute("name")}}`}for(var x,b=_.hasAttribute("title")?_.getAttribute("title"):"Query this layer",v=f.match(p),E=_.hasAttribute("rel")&&"tile"!==_.getAttribute("rel").toLowerCase()?_.getAttribute("rel").toLowerCase():"tile",T=_.hasAttribute("type")?_.getAttribute("type").toLowerCase():"image/*",A=[],S=_&&_.hasAttribute("tms"),C=e.querySelector("meta[name=zoom]")?M.metaContentToObject(e.querySelector("meta[name=zoom]").getAttribute("content")):void 0;null!==(x=p.exec(f));){var z=x[1],k=s.querySelector("input[name="+z+"],select[name="+z+"]");if(!k){console.log("input with name="+z+" not found for template variable of same name");break}if(k.hasAttribute("type")&&"location"===k.getAttribute("type")&&!k.hasAttribute("min")&&k.hasAttribute("axis")&&!["i","j"].includes(k.getAttribute("axis").toLowerCase())){h.setAttribute("value",y.zoom);let t=k.getAttribute("axis"),e=M.convertPCRSBounds(y.bounds,y.zoom,o,M.axisToCS(t));k.setAttribute("min",e.min[M.axisToXY(t)]),k.setAttribute("max",e.max[M.axisToXY(t)])}if(A.push(k),d=d||k.hasAttribute("type")&&"zoom"===k.getAttribute("type").toLowerCase(),k.hasAttribute("shard")){var w=k.getAttribute("list");k.servers=[];var I=s.querySelectorAll("datalist#"+w+" > option");0===I.length&&k.hasAttribute("value")&&(I=k.getAttribute("value").split(""));for(var B=0;B<I.length;B++)I[B].getAttribute?k.servers.push(I[B].getAttribute("value")):k.servers.push(I[B])}else if("select"===k.tagName.toLowerCase()){var P=document.createElement("div");P.insertAdjacentHTML("afterbegin",k.outerHTML),k.htmlselect=P.querySelector("select"),L.DomEvent.on(k.htmlselect,"change",i.redraw,i),i._userInputs||(i._userInputs=[]),i._userInputs.push(k.htmlselect)}}(f&&v.length===A.length||f===a)&&("query"===E&&(i.queryable=!0),!d&&h&&A.push(h),i._templateVars.push({template:decodeURI(new URL(f,u)),linkEl:_,title:b,rel:E,type:T,values:A,zoomBounds:C,projectionMatch:r||m,projection:s.getAttribute("units")||n,tms:S}))}}}else s=i._synthesizeExtent(e),e.querySelector("feature,image,tile")&&(i._content=e);i._parseLicenseAndLegend(e,i),i._extent=s;var N=e.querySelector("link[rel=zoomin]"),q=e.querySelector("link[rel=zoomout]");if(delete i._extent.zoomin,delete i._extent.zoomout,N&&(i._extent.zoomin=new URL(N.getAttribute("href"),u).href),q&&(i._extent.zoomout=new URL(q.getAttribute("href"),u).href),i._templatedLayer&&i._templatedLayer.reset(i._templateVars),e.querySelector("tile")){var D=document.createElement("tiles"),O=e.querySelector("meta[name=zoom][content]")||e.querySelector("input[type=zoom][value]");D.setAttribute("zoom",O&&O.getAttribute("content")||O&&O.getAttribute("value")||"0");for(var R=e.getElementsByTagName("tile"),j=0;j<R.length;j++)D.appendChild(document.importNode(R[j],!0));i._mapmlTileContainer.appendChild(D)}M.parseStylesheetAsHTML(e,u,i._container);var U=e.querySelectorAll('link[rel=style],link[rel="self style"],link[rel="style self"]');if(U.length>1){var F=document.createElement("details"),Z=document.createElement("summary");Z.innerText="Style",F.appendChild(Z);for(var G=function(t){i.fire("changestyle",{src:t.target.getAttribute("data-href")},!1)},$=0;$<U.length;$++){var H=document.createElement("span"),V=H.appendChild(document.createElement("input"));V.setAttribute("type","radio"),V.setAttribute("id","rad"+$),V.setAttribute("name","styles"),V.setAttribute("value",U[$].getAttribute("title")),V.setAttribute("data-href",new URL(U[$].getAttribute("href"),u).href);var W=H.appendChild(document.createElement("label"));W.setAttribute("for","rad"+$),W.innerText=U[$].getAttribute("title"),"style self"!==U[$].getAttribute("rel")&&"self style"!==U[$].getAttribute("rel")||(V.checked=!0),F.appendChild(H),L.DomUtil.addClass(F,"mapml-control-layers"),L.DomEvent.on(V,"click",G,i)}i._styles=F}e.querySelector("title")?i._title=e.querySelector("title").textContent.trim():e.hasAttribute("label")&&(i._title=e.getAttribute("label").trim()),i._map&&(i._validateExtent(),i._map.hasLayer(i)&&i._map.attributionControl.addAttribution(i.getAttribution()))}else i.error=!0;i.fire("extentload",i,!1)}},_createExtent:function(){var t=document.createElement("extent"),e=document.createElement("input"),o=document.createElement("input"),i=document.createElement("input"),n=document.createElement("input"),a=document.createElement("input"),s=document.createElement("input");return a.setAttribute("type","zoom"),a.setAttribute("min","0"),a.setAttribute("max","0"),e.setAttribute("type","xmin"),e.setAttribute("min",""),e.setAttribute("max",""),o.setAttribute("type","ymin"),o.setAttribute("min",""),o.setAttribute("max",""),i.setAttribute("type","xmax"),i.setAttribute("min",""),i.setAttribute("max",""),n.setAttribute("type","ymax"),n.setAttribute("min",""),n.setAttribute("max",""),s.setAttribute("type","projection"),s.setAttribute("value","WGS84"),t.appendChild(e),t.appendChild(o),t.appendChild(i),t.appendChild(n),t.appendChild(a),t.appendChild(s),t},_validateExtent:function(){var t=this._extent;if(t&&t.querySelector&&this._map){if(t.querySelector('[type=xmin][min=""], [type=xmin][max=""], [type=xmax][min=""], [type=xmax][max=""], [type=ymin][min=""], [type=ymin][max=""]')){var e,o,i=t.querySelector("[type=xmin]"),n=t.querySelector("[type=ymin]"),a=t.querySelector("[type=xmax]"),s=t.querySelector("[type=ymax]"),r=t.querySelector("[type=projection][value]");r?(o=r.getAttribute("value"))&&"WGS84"===o?(e=this._map.getBounds(),i.setAttribute("min",e.getWest()),i.setAttribute("max",e.getEast()),n.setAttribute("min",e.getSouth()),n.setAttribute("max",e.getNorth()),a.setAttribute("min",e.getWest()),a.setAttribute("max",e.getEast()),s.setAttribute("min",e.getSouth()),s.setAttribute("max",e.getNorth())):o&&(e=this._map.getPixelBounds(),i.setAttribute("min",e.getBottomLeft().x),i.setAttribute("max",e.getTopRight().x),n.setAttribute("min",e.getTopRight().y),n.setAttribute("max",e.getBottomLeft().y),a.setAttribute("min",e.getBottomLeft().x),a.setAttribute("max",e.getTopRight().x),s.setAttribute("min",e.getTopRight().y),s.setAttribute("max",e.getBottomLeft().y)):this.error=!0}if(t.querySelector('[type=zoom][min=""], [type=zoom][max=""]')){var l=t.querySelector("[type=zoom]");l.setAttribute("min",this._map.getMinZoom()),l.setAttribute("max",this._map.getMaxZoom())}var m=t.hasAttribute("units")?t.getAttribute("units"):null;m&&M[m]?this.crs=M[m]:this.crs=M.OSMTILE}},_getMapMLExtent:function(t,e,o){var i=this._createExtent(),n=i.querySelector("input[type=zoom]"),a=i.querySelector("input[type=xmin]"),s=i.querySelector("input[type=ymin]"),r=i.querySelector("input[type=xmax]"),l=i.querySelector("input[type=ymax]"),m=i.querySelector("input[type=projection]"),u=void 0!==e[0]&&void 0!==e[1]?Math.min(e[0],e[1]):"",c=void 0!==e[0]&&void 0!==e[1]?Math.max(e[0],e[1]):"",p=t?t._southWest?t.getWest():t.getBottomLeft().x:"",h=t?t._southWest?t.getSouth():t.getTopRight().y:"",d=t?t._southWest?t.getEast():t.getTopRight().x:"",y=t?t._southWest?t.getNorth():t.getBottomLeft().y:"";return n.setAttribute("min","number"==typeof u&&isNaN(u)?"":u),n.setAttribute("max","number"==typeof c&&isNaN(c)?"":c),a.setAttribute("min",p),a.setAttribute("max",d),s.setAttribute("min",h),s.setAttribute("max",y),r.setAttribute("min",p),r.setAttribute("max",d),l.setAttribute("min",h),l.setAttribute("max",y),m.setAttribute("value",t&&t._southWest&&!o?"WGS84":o),i},_synthesizeExtent:function(t){var e,o,i,a,s,r,l,m,u,c,p,h,d=t.querySelectorAll("meta[name=zoom]")[0],y=t.querySelector("meta[name=extent]"),g=t.querySelector("meta[name=projection]"),_=g?g.getAttribute("content"):n;if(d)for(o=d.getAttribute("content").split(","),e=0;e<o.length;e++)p=(c=o[e].split("="))[0],h=c[1],"min"===p&&(a=parseInt(h)),"max"===p&&(s=parseInt(h));if(y)for(o=y.getAttribute("content").split(","),e=0;e<o.length;e++)p=(c=o[e].split("="))[0],h=c[1],"xmin"===p&&(r=parseFloat(h)),"xmax"===p&&(m=parseFloat(h)),"ymin"===p&&(l=parseFloat(h)),"ymax"===p&&(u=parseFloat(h));if(r&&l&&m&&u&&"WGS84"===_){var f=L.latLng(l,r),x=L.latLng(u,m);i=L.latLngBounds(f,x)}else r&&l&&m&&u&&(i=L.bounds([[r,l],[m,u]]));return this._getMapMLExtent(i,[a,s],_)},getProjection:function(){let t=this._extent;if(!t)return n;switch(t.tagName.toUpperCase()){case"EXTENT":if(t.hasAttribute("units"))return t.getAttribute("units").toUpperCase();break;case"INPUT":if(t.hasAttribute("value"))return t.getAttribute("value").toUpperCase();break;case"META":if(t.hasAttribute("content"))return M.metaContentToObject(t.getAttribute("content")).content.toUpperCase();break;default:return n}return n},_parseLicenseAndLegend:function(t,e){var o,i,n=t.querySelector("link[rel=license]");n&&(o=n.getAttribute("title"),i='<a href="'+n.getAttribute("href")+'" title="'+o+'">'+o+"</a>"),L.setOptions(e,{attribution:i});var a=t.querySelector("link[rel=legend]");a&&(e._legendUrl=a.getAttribute("href"))},_getUnprojectedMapLatLngBounds:function(t){var e=(t=t||this._map).getPixelOrigin(),o=t.getPixelBounds(),i=t.unproject(e),n=t.unproject(o.getBottomLeft()),a=t.unproject(o.getTopRight()),s=t.unproject(e.add(t.getSize()));return L.latLngBounds(n,a).extend(s).extend(i)},_projectionMatches:function(t){t=t||this._map;var e=this.getProjection();return!(!t.options.projection||"WGS84"!==e&&t.options.projection!==e)},getQueryTemplates:function(){if(this._templatedLayer&&this._templatedLayer._queries)return this._templatedLayer._queries},_attachSkipButtons:function(t){let e,o,i=t.popup,n=t.target,a=i._container.getElementsByClassName("mapml-popup-content")[0];a.setAttribute("tabindex","-1"),i._count=0,i._source._eventParents?(e=i._source._eventParents[Object.keys(i._source._eventParents)[0]],o=i._source._path):e=i._source._templatedLayer,i._container.querySelector('div[class="mapml-focus-buttons"]')&&(L.DomUtil.remove(i._container.querySelector('div[class="mapml-focus-buttons"]')),L.DomUtil.remove(i._container.querySelector("hr")));let s=L.DomUtil.create("div","mapml-focus-buttons"),r=L.DomUtil.create("a","mapml-popup-button",s);r.href="#",r.role="button",r.title="Focus Map",r.innerHTML="<span aria-hidden='true'>|&#10094;</span>",L.DomEvent.disableClickPropagation(r),L.DomEvent.on(r,"click",L.DomEvent.stop),L.DomEvent.on(r,"click",t=>{n.closePopup(),n._container.focus()},i);let l=L.DomUtil.create("a","mapml-popup-button",s);l.href="#",l.role="button",l.title="Previous Feature",l.innerHTML="<span aria-hidden='true'>&#10094;</span>",L.DomEvent.disableClickPropagation(l),L.DomEvent.on(l,"click",L.DomEvent.stop),L.DomEvent.on(l,"click",e._previousFeature,i);let m=L.DomUtil.create("p","mapml-feature-count",s),u=this._totalFeatureCount?this._totalFeatureCount:1;m.innerText=i._count+1+"/"+u;let c=L.DomUtil.create("a","mapml-popup-button",s);c.href="#",c.role="button",c.title="Next Feature",c.innerHTML="<span aria-hidden='true'>&#10095;</span>",L.DomEvent.disableClickPropagation(c),L.DomEvent.on(c,"click",L.DomEvent.stop),L.DomEvent.on(c,"click",e._nextFeature,i);let p=L.DomUtil.create("a","mapml-popup-button",s);p.href="#",p.role="button",p.title="Focus Controls",p.innerHTML="<span aria-hidden='true'>&#10095;|</span>",L.DomEvent.disableClickPropagation(p),L.DomEvent.on(p,"click",L.DomEvent.stop),L.DomEvent.on(p,"click",t=>{n.closePopup(),n._controlContainer.querySelector("A").focus()},i);let h=L.DomUtil.create("hr");function d(t){let e=9===t.originalEvent.keyCode,a=t.originalEvent.shiftKey;t.originalEvent.path[0].classList.contains("leaflet-popup-close-button")&&e&&!a||27===t.originalEvent.keyCode?(L.DomEvent.stop(t),n.closePopup(i),o.focus()):("Focus Map"===t.originalEvent.path[0].title||t.originalEvent.path[0].classList.contains("mapml-popup-content"))&&e&&a&&setTimeout(()=>{L.DomEvent.stop(t),n.closePopup(i),o.focus()},0)}function y(t){let e=9===t.originalEvent.keyCode,o=t.originalEvent.shiftKey;13===t.originalEvent.keyCode&&t.originalEvent.path[0].classList.contains("leaflet-popup-close-button")||27===t.originalEvent.keyCode?(L.DomEvent.stopPropagation(t),n._container.focus(),n.closePopup(i),27!==t.originalEvent.keyCode&&(n._popupClosed=!0)):e&&t.originalEvent.path[0].classList.contains("leaflet-popup-close-button")?n.closePopup(i):("Focus Map"===t.originalEvent.path[0].title||t.originalEvent.path[0].classList.contains("mapml-popup-content"))&&e&&o&&setTimeout(()=>{L.DomEvent.stop(t),n.closePopup(i),n._container.focus()},0)}h.style.borderTop="1px solid #bbb",i._navigationBar=s,i._content.appendChild(h),i._content.appendChild(s),a.focus(),o?(o.setAttribute("aria-expanded","true"),n.on("keydown",d)):n.on("keydown",y),n.on("popupclose",function t(e){e.popup===i&&(n.off("keydown",d),n.off("keydown",y),n.off("popupclose",t),o&&o.setAttribute("aria-expanded","false"))})}}),x=function(t,e,o){return t||e?new f(t,e,o):null},b=L.Layer.extend({onAdd:function(t){let e=t.getSize();(e.x>400||e.y>300)&&(this._container=L.DomUtil.create("div","mapml-debug",t._container),this._container.style.width=150,this._container.style.zIndex=1e4,this._container.style.position="absolute",this._container.style.top="auto",this._container.style.bottom="5px",this._container.style.left="5px",this._container.style.right="auto",this._panel=T({className:"mapml-debug-panel",pane:this._container}),t.addLayer(this._panel)),this._grid=S({className:"mapml-debug-grid",pane:t._panes.mapPane,zIndex:400,tileSize:t.options.crs.options.crs.tile.bounds.max.x}),t.addLayer(this._grid),this._vectors=z({className:"mapml-debug-vectors",pane:t._panes.mapPane,toolPane:this._container}),t.addLayer(this._vectors)},onRemove:function(t){t.removeLayer(this._grid),t.removeLayer(this._vectors),this._panel&&(t.removeLayer(this._panel),L.DomUtil.remove(this._container))}}),v=function(){return new b},E=L.Layer.extend({initialize:function(t){L.setOptions(this,t)},onAdd:function(t){this._title=L.DomUtil.create("div","mapml-debug-banner",this.options.pane),this._title.innerHTML="Debug mode",t.debug={},t.debug._infoContainer=this._debugContainer=L.DomUtil.create("div","mapml-debug-panel",this.options.pane);let e=t.debug._infoContainer;t.debug._tileCoord=L.DomUtil.create("div","mapml-debug-coordinates",e),t.debug._tileMatrixCoord=L.DomUtil.create("div","mapml-debug-coordinates",e),t.debug._mapCoord=L.DomUtil.create("div","mapml-debug-coordinates",e),t.debug._tcrsCoord=L.DomUtil.create("div","mapml-debug-coordinates",e),t.debug._pcrsCoord=L.DomUtil.create("div","mapml-debug-coordinates",e),t.debug._gcrsCoord=L.DomUtil.create("div","mapml-debug-coordinates",e),this._map.on("mousemove",this._updateCoords)},onRemove:function(){L.DomUtil.remove(this._title),this._debugContainer&&(L.DomUtil.remove(this._debugContainer),this._map.off("mousemove",this._updateCoords))},_updateCoords:function(t){if(this.contextMenu._visible)return;let e=this.options.mapEl,o=e._map.project(t.latlng),i=e._map.options.crs.scale(+e.zoom),n=e._map.options.crs.transformation.untransform(o,i),a=e._map.options.crs.options.crs.tile.bounds.max.x,s=o.x%a,r=o.y%a;s<0&&(s+=a),r<0&&(r+=a),this.debug._tileCoord.innerHTML=`tile: i: ${Math.trunc(s)}, j: ${Math.trunc(r)}`,this.debug._mapCoord.innerHTML=`map: i: ${Math.trunc(t.containerPoint.x)}, j: ${Math.trunc(t.containerPoint.y)}`,this.debug._gcrsCoord.innerHTML=`gcrs: lon: ${t.latlng.lng.toFixed(6)}, lat: ${t.latlng.lat.toFixed(6)}`,this.debug._tcrsCoord.innerHTML=`tcrs: x:${Math.trunc(o.x)}, y:${Math.trunc(o.y)}`,this.debug._tileMatrixCoord.innerHTML=`tilematrix: column:${Math.trunc(o.x/a)}, row:${Math.trunc(o.y/a)}`,this.debug._pcrsCoord.innerHTML=`pcrs: easting:${n.x.toFixed(2)}, northing:${n.y.toFixed(2)}`}}),T=function(t){return new E(t)},A=L.GridLayer.extend({initialize:function(t){L.setOptions(this,t),L.GridLayer.prototype.initialize.call(this,this._map)},createTile:function(t){let e=L.DomUtil.create("div","mapml-debug-tile");return e.setAttribute("col",t.x),e.setAttribute("row",t.y),e.setAttribute("zoom",t.z),e.innerHTML=[`col: ${t.x}`,`row: ${t.y}`,`zoom: ${t.z}`].join(", "),e.style.outline="1px dashed red",e}}),S=function(t){return new A(t)},C=L.LayerGroup.extend({initialize:function(t){L.setOptions(this,t),L.LayerGroup.prototype.initialize.call(this,this._map,t)},onAdd:function(t){t.on("overlayremove",this._mapLayerUpdate,this),t.on("overlayadd",this._mapLayerUpdate,this);let e=t.options.crs.transformation.transform(L.point(0,0),t.options.crs.scale(0));this._centerVector=L.circle(t.options.crs.pointToLatLng(e,0),{radius:250}),this._centerVector.bindTooltip("Projection Center"),this._addBounds(t)},onRemove:function(t){this.clearLayers()},_addBounds:function(t){let e=Object.keys(t._layers),o=t._layers,i=["#FF5733","#8DFF33","#3397FF","#E433FF","#F3FF33"],n=0;this.addLayer(this._centerVector);for(let t of e)if(o[t].layerBounds){let e=[o[t].layerBounds.min,L.point(o[t].layerBounds.max.x,o[t].layerBounds.min.y),o[t].layerBounds.max,L.point(o[t].layerBounds.min.x,o[t].layerBounds.max.y)],a=w(e,{color:i[n%i.length],weight:2,opacity:1,fillOpacity:.01,fill:!0});o[t].options._leafletLayer&&a.bindTooltip(o[t].options._leafletLayer._title,{sticky:!0}),this.addLayer(a),n++}},_mapLayerUpdate:function(t){this.clearLayers(),this._addBounds(t.target)}}),z=function(t){return new C(t)},k=L.Path.extend({initialize:function(t,e){this._locations=t,L.setOptions(this,e)},_project:function(){this._rings=[];let t=this._map.options.crs.scale(this._map.getZoom()),e=this._map;for(let o=0;o<this._locations.length;o++){let i=e.options.crs.transformation.transform(this._locations[o],t);this._rings.push(L.point(i.x,i.y)._subtract(e.getPixelOrigin()))}this._parts=[this._rings]},_update:function(){this._map&&this._renderer._updatePoly(this,!0)}}),w=function(t,e){return new k(t,e)},I=L.Handler.extend({addHooks:function(){L.setOptions(this,{mapEl:this._map.options.mapEl}),L.DomEvent.on(this._map,"click",this._queryTopLayer,this),L.DomEvent.on(this._map,"keypress",this._queryTopLayerAtMapCenter,this)},removeHooks:function(){L.DomEvent.off(this._map,"click",this._queryTopLayer,this),L.DomEvent.on(this._map,"keypress",this._queryTopLayerAtMapCenter,this)},_getTopQueryableLayer:function(){for(var t=this.options.mapEl.layers,e=t.length-1;e>=0;e--){var o=t[e]._layer;if(t[e].checked&&o.queryable)return o}},_queryTopLayerAtMapCenter:function(t){setTimeout(()=>{!this._map.isFocused||this._map._popupClosed||" "!==t.originalEvent.key&&13!=+t.originalEvent.keyCode?delete this._map._popupClosed:this._map.fire("click",{latlng:this._map.getCenter(),layerPoint:this._map.latLngToLayerPoint(this._map.getCenter()),containerPoint:this._map.latLngToContainerPoint(this._map.getCenter())})},0)},_queryTopLayer:function(t){var e=this._getTopQueryableLayer();e&&this._query(t,e)},_query(t,e){var o={},i=e.getQueryTemplates()[0],n=t.target.getZoom(),a=this._map,s=e.crs,r=a.options.crs.options.crs.tile.bounds.max.x,l=e._container,m={autoClose:!1,autoPan:!0,maxHeight:.5*a.getSize().y-50},u=function(t){return s.transformation.untransform(t,s.scale(n))},c=function(t){return s.unproject(s.transformation.untransform(t,s.scale(n)),n)},p=s.latLngToPoint(t.latlng,n),h=p.divideBy(r).floor(),d=new L.Bounds(p.divideBy(r).floor().multiplyBy(r),p.divideBy(r).ceil().multiplyBy(r));for(var y in o[i.query.tilei]=p.x.toFixed()-h.x*r,o[i.query.tilej]=p.y.toFixed()-h.y*r,o[i.query.mapi]=a.getSize().divideBy(2).x.toFixed(),o[i.query.mapj]=a.getSize().divideBy(2).y.toFixed(),o[i.query.pixelleft]=s.pointToLatLng(p,n).lng,o[i.query.pixeltop]=s.pointToLatLng(p,n).lat,o[i.query.pixelright]=s.pointToLatLng(p.add([1,1]),n).lng,o[i.query.pixelbottom]=s.pointToLatLng(p.add([1,1]),n).lat,o[i.query.column]=h.x,o[i.query.row]=h.y,o[i.query.x]=p.x.toFixed(),o[i.query.y]=p.y.toFixed(),o[i.query.easting]=u(p).x,o[i.query.northing]=u(p).y,o[i.query.longitude]=c(p).lng,o[i.query.latitude]=c(p).lat,o[i.query.zoom]=n,o[i.query.width]=a.getSize().x,o[i.query.height]=a.getSize().y,o[i.query.mapbottom]=u(p.add(a.getSize().divideBy(2))).y,o[i.query.mapleft]=u(p.subtract(a.getSize().divideBy(2))).x,o[i.query.maptop]=u(p.subtract(a.getSize().divideBy(2))).y,o[i.query.mapright]=u(p.add(a.getSize().divideBy(2))).x,o[i.query.tilebottom]=u(d.max).y,o[i.query.tileleft]=u(d.min).x,o[i.query.tiletop]=u(d.min).y,o[i.query.tileright]=u(d.max).x,i.query)["mapi","mapj","tilei","tilej","row","col","x","y","easting","northing","longitude","latitude","width","height","zoom","mapleft","mapright",",maptop","mapbottom","tileleft","tileright","tiletop","tilebottom","pixeltop","pixelbottom","pixelleft","pixelright"].indexOf(y)<0&&(o[y]=i.query[y]);let g,_=this._map.project(t.latlng),f=this._map.options.crs.scale(this._map.getZoom()),x=this._map.options.crs.transformation.untransform(_,f);i.layerBounds.contains(x)&&fetch(L.Util.template(i.template,o),{redirect:"follow"}).then(t=>{if(g=t.headers.get("Content-Type"),t.status>=200&&t.status<300)return t.text();throw new Error(t.status)}).then(o=>g.startsWith("text/mapml")?function(t,o){var i=(new DOMParser).parseFromString(t,"application/xml"),n=M.mapMlFeatures(i,{renderer:L.svg(),pane:l,projection:a.options.projection,_leafletLayer:e,imagePath:M.detectImagePath(a.getContainer()),query:!0});n.addTo(a);let s=L.DomUtil.create("div","mapml-popup-content"),r=L.DomUtil.create("iframe");r.style="border: none",r.srcdoc='<meta http-equiv="content-security-policy" content="script-src \'none\';">'+i.querySelector("feature properties").innerHTML,s.appendChild(r),e._totalFeatureCount=i.querySelectorAll("feature").length,e.bindPopup(s,m).openPopup(o),e.on("popupclose",function(){a.removeLayer(n)}),n.showPaginationFeature({i:0,popup:e._popup})}(o,t.latlng):function(t,e,o){let i=L.DomUtil.create("div","mapml-popup-content"),n=L.DomUtil.create("iframe");n.style="border: none",n.srcdoc='<meta http-equiv="content-security-policy" content="script-src \'none\';">'+t,i.appendChild(n),e.bindPopup(i,m).openPopup(o)}(o,e,t.latlng)).catch(t=>{console.log("Looks like there was a problem. Status: "+t.message)})}}),B=L.Handler.extend({_touchstart:L.Browser.msPointer?"MSPointerDown":L.Browser.pointer?"pointerdown":"touchstart",initialize:function(t){L.Handler.prototype.initialize.call(this,t),this._items=[{text:"Back (<kbd>B</kbd>)",callback:this._goBack},{text:"Forward (<kbd>F</kbd>)",callback:this._goForward},{text:"Reload (<kbd>R</kbd>)",callback:this._reload},{spacer:"-"},{text:"Toggle Controls (<kbd>T</kbd>)",callback:this._toggleControls},{text:"Copy Coordinates (<kbd>C</kbd>) <span aria-hidden='true'>></span>",callback:this._copyCoords,hideOnSelect:!1,popup:!0,submenu:[{text:"tile",callback:this._copyTile},{text:"tilematrix",callback:this._copyTileMatrix},{spacer:"-"},{text:"map",callback:this._copyMap},{spacer:"-"},{text:"tcrs",callback:this._copyTCRS},{text:"pcrs",callback:this._copyPCRS},{text:"gcrs",callback:this._copyGCRS},{spacer:"-"},{text:"All",callback:this._copyAllCoords}]},{text:"Toggle Debug Mode (<kbd>D</kbd>)",callback:this._toggleDebug},{text:"View Map Source (<kbd>V</kbd>)",callback:this._viewSource}],this._layerItems=[{text:"Zoom To Layer (<kbd>Z</kbd>)",callback:this._zoomToLayer},{text:"Copy Extent (<kbd>C</kbd>)",callback:this._copyLayerExtent}],this._mapMenuVisible=!1,this._keyboardEvent=!1,this._container=L.DomUtil.create("div","mapml-contextmenu",t._container),this._container.style.zIndex=10001,this._container.style.position="absolute",this._container.style.width="150px";for(let t=0;t<6;t++)this._items[t].el=this._createItem(this._container,this._items[t]);this._coordMenu=L.DomUtil.create("div","mapml-contextmenu mapml-submenu",this._container),this._coordMenu.style.zIndex=10001,this._coordMenu.style.position="absolute",this._coordMenu.style.width="80px",this._coordMenu.id="mapml-copy-submenu",this._clickEvent=null;for(let t=0;t<this._items[5].submenu.length;t++)this._createItem(this._coordMenu,this._items[5].submenu[t],t);this._items[6].el=this._createItem(this._container,this._items[6]),this._items[7].el=this._createItem(this._container,this._items[7]),this._layerMenu=L.DomUtil.create("div","mapml-contextmenu mapml-layer-menu",t._container),this._layerMenu.style.zIndex=10001,this._layerMenu.style.position="absolute",this._layerMenu.style.width="150px";for(let t=0;t<this._layerItems.length;t++)this._createItem(this._layerMenu,this._layerItems[t]);L.DomEvent.on(this._container,"click",L.DomEvent.stop).on(this._container,"mousedown",L.DomEvent.stop).on(this._container,"dblclick",L.DomEvent.stop).on(this._container,"contextmenu",L.DomEvent.stop).on(this._layerMenu,"click",L.DomEvent.stop).on(this._layerMenu,"mousedown",L.DomEvent.stop).on(this._layerMenu,"dblclick",L.DomEvent.stop).on(this._layerMenu,"contextmenu",L.DomEvent.stop)},addHooks:function(){var t=this._map.getContainer();L.DomEvent.on(t,"mouseleave",this._hide,this).on(document,"keydown",this._onKeyDown,this),L.Browser.touch&&L.DomEvent.on(document,this._touchstart,this._hide,this),this._map.on({contextmenu:this._show,mousedown:this._hide,zoomstart:this._hide},this)},removeHooks:function(){var t=this._map.getContainer();L.DomEvent.off(t,"mouseleave",this._hide,this).off(document,"keydown",this._onKeyDown,this),L.Browser.touch&&L.DomEvent.off(document,this._touchstart,this._hide,this),this._map.off({contextmenu:this._show,mousedown:this._hide,zoomstart:this._hide},this)},_copyLayerExtent:function(t){let e=t instanceof KeyboardEvent?this._map.contextMenu:this.contextMenu,o=e._layerClicked.layer._layerEl,i=o.extent.topLeft.pcrs,n=o.extent.bottomRight.pcrs,a=`top-left-easting,${i.horizontal}\ntop-left-northing,${i.vertical}\n`;a+=`bottom-right-easting,${n.horizontal}\nbottom-right-northing,${n.vertical}`,e._copyData(a)},_zoomToLayer:function(t){let e=t instanceof KeyboardEvent?this._map:this,o=e.contextMenu._layerClicked.layer._layerEl,i=o.extent.topLeft.pcrs,n=o.extent.bottomRight.pcrs,a=L.bounds(L.point(i.horizontal,i.vertical),L.point(n.horizontal,n.vertical)),s=e.options.crs.unproject(a.getCenter(!0)),r=e.getZoom();e.setView(s,r,{animate:!1});let l=M.pixelToPCRSBounds(e.getPixelBounds(),e.getZoom(),e.options.projection);if(l.contains(a)){for(;l.contains(a)&&r+1<=o.extent.zoom.maxZoom;)r++,e.setView(s,r,{animate:!1}),l=M.pixelToPCRSBounds(e.getPixelBounds(),e.getZoom(),e.options.projection);r-1>=0&&e.flyTo(s,r-1)}else for(;!l.contains(a)&&r-1>=o.extent.zoom.minZoom;)r--,e.setView(s,r,{animate:!1}),l=M.pixelToPCRSBounds(e.getPixelBounds(),e.getZoom(),e.options.projection)},_goForward:function(t){(t instanceof KeyboardEvent?this._map.options.mapEl:this.options.mapEl).forward()},_goBack:function(t){(t instanceof KeyboardEvent?this._map.options.mapEl:this.options.mapEl).back()},_reload:function(t){(t instanceof KeyboardEvent?this._map.options.mapEl:this.options.mapEl).reload()},_toggleControls:function(t){(t instanceof KeyboardEvent?this._map.options.mapEl:this.options.mapEl)._toggleControls()},_viewSource:function(t){(t instanceof KeyboardEvent?this._map.options.mapEl:this.options.mapEl).viewSource()},_toggleDebug:function(t){(t instanceof KeyboardEvent?this._map.options.mapEl:this.options.mapEl).toggleDebug()},_copyCoords:function(t){(this.contextMenu?this.contextMenu:this)._showCoordMenu(t)},_copyData:function(t){const e=document.createElement("textarea");e.value=t,document.body.appendChild(e),e.select(),document.execCommand("copy"),document.body.removeChild(e)},_copyGCRS:function(t){let e=this.options.mapEl,o=this.contextMenu._clickEvent;this.contextMenu._copyData(`z:${e.zoom}, lon :${o.latlng.lng.toFixed(6)}, lat:${o.latlng.lat.toFixed(6)}`)},_copyTCRS:function(t){let e=this.options.mapEl,o=this.contextMenu._clickEvent,i=e._map.project(o.latlng);this.contextMenu._copyData(`z:${e.zoom}, x:${i.x}, y:${i.y}`)},_copyTileMatrix:function(t){let e=this.options.mapEl,o=this.contextMenu._clickEvent,i=e._map.project(o.latlng),n=e._map.options.crs.options.crs.tile.bounds.max.x;this.contextMenu._copyData(`z:${e.zoom}, column:${Math.trunc(i.x/n)}, row:${Math.trunc(i.y/n)}`)},_copyPCRS:function(t){let e=this.options.mapEl,o=this.contextMenu._clickEvent,i=e._map.project(o.latlng),n=e._map.options.crs.scale(+e.zoom),a=e._map.options.crs.transformation.untransform(i,n);this.contextMenu._copyData(`z:${e.zoom}, easting:${a.x.toFixed(2)}, northing:${a.y.toFixed(2)}`)},_copyTile:function(t){let e=this.options.mapEl,o=this.contextMenu._clickEvent,i=e._map.options.crs.project(o.latlng),n=e._map.options.crs.options.crs.tile.bounds.max.x,a=i.x%n,s=i.y%n;a<0&&(a+=n),s<0&&(s+=n),this.contextMenu._copyData(`z:${e.zoom}, i:${Math.trunc(a)}, j:${Math.trunc(s)}`)},_copyMap:function(t){let e=this.options.mapEl,o=this.contextMenu._clickEvent;this.contextMenu._copyData(`z:${e.zoom}, i:${Math.trunc(o.containerPoint.x)}, j:${Math.trunc(o.containerPoint.y)}`)},_copyAllCoords:function(t){let e=this.options.mapEl,o=this.contextMenu._clickEvent,i=e._map.project(o.latlng),n=e._map.options.crs.options.crs.tile.bounds.max.x,a=i.x%n,s=i.y%n,r=e._map.options.crs.scale(+e.zoom),l=e._map.options.crs.transformation.untransform(i,r),m=`z:${e.zoom}\n`;m+=`tile: i:${Math.trunc(a)}, j:${Math.trunc(s)}\n`,m+=`tilematrix: column:${Math.trunc(i.x/n)}, row:${Math.trunc(i.y/n)}\n`,m+=`map: i:${Math.trunc(o.containerPoint.x)}, j:${Math.trunc(o.containerPoint.y)}\n`,m+=`tcrs: x:${Math.trunc(i.x)}, y:${Math.trunc(i.y)}\n`,m+=`pcrs: easting:${l.x.toFixed(2)}, northing:${l.y.toFixed(2)}\n`,m+=`gcrs: lon :${o.latlng.lng.toFixed(6)}, lat:${o.latlng.lat.toFixed(6)}`,this.contextMenu._copyData(m)},_createItem:function(t,e,o){if(e.spacer)return this._createSeparator(t,o);var i=this._insertElementAt("a","mapml-contextmenu-item",t,o),n=this._createEventHandler(i,e.callback,e.context,e.hideOnSelect);return i.innerHTML=""+e.text,i.href="#",i.setAttribute("role","button"),e.popup&&(i.setAttribute("aria-haspopup","true"),i.setAttribute("aria-expanded","false"),i.setAttribute("aria-controls","mapml-copy-submenu")),L.DomEvent.on(i,"mouseover",this._onItemMouseOver,this).on(i,"mouseout",this._onItemMouseOut,this).on(i,"mousedown",L.DomEvent.stopPropagation).on(i,"click",n),L.Browser.touch&&L.DomEvent.on(i,this._touchstart,L.DomEvent.stopPropagation),L.Browser.pointer||L.DomEvent.on(i,"click",this._onItemMouseOut,this),{id:L.Util.stamp(i),el:i,callback:n}},_createSeparator:function(t,e){let o=this._insertElementAt("div","mapml-contextmenu-separator",t,e);return{id:L.Util.stamp(o),el:o}},_createEventHandler:function(t,e,o,i){let n=this;return i=void 0===i||i,function(a){let s=n._map,r=n._showLocation.containerPoint,l=s.containerPointToLayerPoint(r),m={containerPoint:r,layerPoint:l,latlng:s.layerPointToLatLng(l),relatedTarget:n._showLocation.relatedTarget};i&&n._hide(),e&&e.call(o||s,m),n._map.fire("contextmenu.select",{contextmenu:n,el:t})}},_insertElementAt:function(t,e,o,i){let n,a=document.createElement(t);return a.className=e,void 0!==i&&(n=o.children[i]),n?o.insertBefore(a,n):o.appendChild(a),a},_show:function(t){this._mapMenuVisible&&this._hide(),this._clickEvent=t;let e=t.originalEvent.srcElement;if(e.closest("fieldset")){if(!(e=e.closest("fieldset").querySelector("span")).layer.validProjection)return;this._layerClicked=e,this._showAtPoint(t.containerPoint,t,this._layerMenu)}else e.classList.contains("leaflet-container")&&(this._layerClicked=void 0,this._showAtPoint(t.containerPoint,t,this._container));0===t.originalEvent.button&&(this._keyboardEvent=!0,this._container.firstChild.focus())},_showAtPoint:function(t,e,o){if(this._items.length){let i=L.extend(e||{},{contextmenu:this});this._showLocation={containerPoint:t},e&&e.relatedTarget&&(this._showLocation.relatedTarget=e.relatedTarget),this._setPosition(t,o),this._mapMenuVisible||(o.style.display="block",this._mapMenuVisible=!0),this._map.fire("contextmenu.show",i)}},_hide:function(){this._mapMenuVisible&&(this._mapMenuVisible=!1,this._container.style.display="none",this._coordMenu.style.display="none",this._layerMenu.style.display="none",this._map.fire("contextmenu.hide",{contextmenu:this}))},_setPosition:function(t,e){let o,i=this._map.getSize(),n=this._getElementSize(e);this._map.options.contextmenuAnchor&&(o=L.point(this._map.options.contextmenuAnchor),t=t.add(o)),e._leaflet_pos=t,t.x+n.x>i.x?(e.style.left="auto",e.style.right=Math.min(Math.max(i.x-t.x,0),i.x-n.x-1)+"px"):(e.style.left=Math.max(t.x,0)+"px",e.style.right="auto"),t.y+n.y>i.y?(e.style.top="auto",e.style.bottom=Math.min(Math.max(i.y-t.y,0),i.y-n.y-1)+"px"):(e.style.top=Math.max(t.y,0)+"px",e.style.bottom="auto")},_getElementSize:function(t){let e=this._size,o=t.style.display;return e&&!this._sizeChanged||(e={},t.style.left="-999999px",t.style.right="auto",t.style.display="block",e.x=t.offsetWidth,e.y=t.offsetHeight,t.style.left="auto",t.style.display=o,this._sizeChanged=!1),e},_debounceKeyDown:function(t,e,o){let i,n=this,a=arguments;clearTimeout(i),i=setTimeout(function(){i=null,o||t.apply(n,a)},e),o&&!i&&t.apply(n,a)},_onKeyDown:function(t){this._mapMenuVisible&&this._debounceKeyDown(function(){let e=t.keyCode;switch(16===e||9===e||!this._layerClicked&&67===e||"Copy Coordinates (C) >"===t.path[0].innerText||this._hide(),e){case 32:this._map._container.parentNode.activeElement.parentNode.classList.contains("mapml-contextmenu")&&this._map._container.parentNode.activeElement.click();break;case 66:this._goBack(t);break;case 67:this._layerClicked?this._copyLayerExtent(t):this._copyCoords({latlng:this._map.getCenter()});break;case 68:this._toggleDebug(t);break;case 70:this._goForward(t);break;case 82:this._reload(t);break;case 84:this._toggleControls(t);break;case 86:this._viewSource(t);break;case 27:this._hide();break;case 90:this._layerClicked&&this._zoomToLayer(t)}},250)},_showCoordMenu:function(t){let e=this._map.getSize(),o=this._clickEvent,i=this._coordMenu;this._items[5].el.el.setAttribute("aria-expanded","true"),i.style.display="block",o.containerPoint.x+150+80>e.x?(i.style.left="auto",i.style.right="150px"):(i.style.left="150px",i.style.right="auto"),o.containerPoint.y+150>e.y?(i.style.top="auto",i.style.bottom="20px"):(i.style.top="100px",i.style.bottom="auto"),this._keyboardEvent&&i.firstChild.focus()},_hideCoordMenu:function(t){if(t.srcElement.parentElement.classList.contains("mapml-submenu")||"Copy Coordinates (C) >"===t.srcElement.innerText)return;let e=this._coordMenu;this._items[5].el.el.setAttribute("aria-expanded","false"),e.style.display="none"},_onItemMouseOver:function(t){L.DomUtil.addClass(t.target||t.srcElement,"over"),"Copy Coordinates (C) >"===t.srcElement.innerText&&this._showCoordMenu(t)},_onItemMouseOut:function(t){L.DomUtil.removeClass(t.target||t.srcElement,"over"),this._hideCoordMenu(t)}}),P={convertAndFormatPCRS:function(t,e){if(!t||!e)return{};let o=[],i=[],n=[],a=[],s=e.options.crs.options.crs.tile.bounds.max.y;for(let r=0;r<e.options.crs.options.resolutions.length;r++){let l=e.options.crs.scale(r),m=e.options.crs.transformation.transform(t.min,l),u=e.options.crs.transformation.transform(t.max,l);o.push({horizontal:m.x,vertical:u.y}),i.push({horizontal:u.x,vertical:m.y}),n.push({horizontal:o[r].horizontal/s,vertical:o[r].vertical/s}),a.push({horizontal:i[r].horizontal/s,vertical:i[r].vertical/s})}let r=e.options.crs.unproject(t.min),l=e.options.crs.unproject(t.max),m={topLeft:{horizontal:r.lng,vertical:l.lat},bottomRight:{horizontal:l.lng,vertical:r.lat}},u={topLeft:{horizontal:t.min.x,vertical:t.max.y},bottomRight:{horizontal:t.max.x,vertical:t.min.y}};return{topLeft:{tcrs:o,tilematrix:n,gcrs:m.topLeft,pcrs:u.topLeft},bottomRight:{tcrs:i,tilematrix:a,gcrs:m.bottomRight,pcrs:u.bottomRight},projection:e.options.projection}},extractInputBounds:function(t){if(!t)return;let e=t.values,o=t.projection||n,i=0,a="TILEMATRIX",s=this[o].options.crs.tilematrix.bounds(0),r=0,l=this[o].options.resolutions.length-1;t.zoomBounds||(t.zoomBounds={},t.zoomBounds.min=0,t.zoomBounds.max=l);for(let t=0;t<e.length;t++)switch(e[t].getAttribute("type")){case"zoom":r=+e[t].getAttribute("min"),l=+e[t].getAttribute("max"),i=+e[t].getAttribute("value");break;case"location":if(!e[t].getAttribute("max")||!e[t].getAttribute("min"))continue;let o=+e[t].getAttribute("max"),n=+e[t].getAttribute("min");switch(e[t].getAttribute("axis").toLowerCase()){case"x":case"longitude":case"column":case"easting":a=M.axisToCS(e[t].getAttribute("axis").toLowerCase()),s.min.x=n,s.max.x=o;break;case"y":case"latitude":case"row":case"northing":a=M.axisToCS(e[t].getAttribute("axis").toLowerCase()),s.min.y=n,s.max.y=o}}return{zoomBounds:{minZoom:+t.zoomBounds.min,maxZoom:+t.zoomBounds.max,minNativeZoom:r,maxNativeZoom:l},bounds:this.boundsToPCRSBounds(s,i,o,a)}},axisToCS:function(t){try{switch(t.toLowerCase()){case"row":case"column":return"TILEMATRIX";case"i":case"j":return["MAP","TILE"];case"x":case"y":return"TCRS";case"latitude":case"longitude":return"GCRS";case"northing":case"easting":return"PCRS";default:return"TILEMATRIX"}}catch(t){return}},csToAxes:function(t){try{switch(t.toLowerCase()){case"tilematrix":return["column","row"];case"map":case"tile":return["i","j"];case"tcrs":return["x","y"];case"gcrs":return["longitude","latitude"];case"pcrs":return["easting","northing"]}}catch(t){return}},axisToXY:function(t){try{switch(t.toLowerCase()){case"i":case"column":case"longitude":case"x":case"easting":return"x";case"row":case"j":case"latitude":case"y":case"northing":return"y";default:return}}catch(t){return}},convertPCRSBounds:function(t,e,o,i){if(t&&(e||0==+e)&&i)switch(i.toLowerCase()){case"pcrs":return t;case"tcrs":case"tilematrix":let n=this[o].transformation.transform(t.min,this[o].scale(+e)),a=this[o].transformation.transform(t.max,this[o].scale(+e));if("tcrs"===i.toLowerCase())return L.bounds(n,a);let s=M[o].options.crs.tile.bounds.max.x;return L.bounds(L.point(n.x/s,n.y/s),L.point(a.x/s,a.y/s));case"gcrs":let r=this[o].unproject(t.min),l=this[o].unproject(t.max);return L.bounds(L.point(r.lng,r.lat),L.point(l.lng,l.lat));default:return}},boundsToPCRSBounds:function(t,e,o,i){if(!t||!e&&0!=+e||!i)return;let n=M[o].options.crs.tile.bounds.max.x;switch(i.toUpperCase()){case"TILEMATRIX":let a=L.bounds(L.point(t.min.x*n,t.min.y*n),L.point(t.max.x*n,t.max.y*n));return M.pixelToPCRSBounds(a,e,o);case"PCRS":return t;case"TCRS":return M.pixelToPCRSBounds(t,e,o);case"GCRS":let s=this[o].project(L.latLng(t.min.y,t.min.x)),r=this[o].project(L.latLng(t.max.y,t.max.x));return L.bounds(s,r);default:return}},pixelToPCRSBounds:function(t,e,o){if(!t||!t.max||!t.min||void 0===e||null===e||e instanceof Object)return;let i=this[o].transformation.untransform(t.min,this[o].scale(e)),n=this[o].transformation.untransform(t.max,this[o].scale(e));return L.bounds(i,n)},metaContentToObject:function(t){if(!t||t instanceof Object)return{};let e={},o=t.split(" ").join("").split(",");for(let t=0;t<o.length;t++){let i=o[t].split("=");2===i.length&&(e[i[0]]=i[1])}return""!==e&&1===o[0].split("=").length&&(e.content=o[0]),e},coordsToArray:function(t){for(var e=1,o=[],i=t.split(",");e<i.length;e+=2)o.push([parseInt(i[e-1]),parseInt(i[e])]);return o},parseStylesheetAsHTML:function(t,e,o){if(o instanceof Element&&t&&t.querySelector("link[rel=stylesheet],style")){if(e instanceof Element)e=e.getAttribute("href")?e.getAttribute("href"):document.URL;else if(!e||""===e||e instanceof Object)return;for(var i=[],n=t.querySelectorAll("link[rel=stylesheet],style"),a=0;a<n.length;a++)if("LINK"===n[a].nodeName.toUpperCase()){var s=n[a].hasAttribute("href")?new URL(n[a].getAttribute("href"),e).href:null;if(s&&!o.querySelector("link[href='"+s+"']")){var r=document.createElement("link");r.setAttribute("href",s),r.setAttribute("rel","stylesheet"),i.push(r)}}else{var l=document.createElement("style");l.textContent=n[a].textContent,i.push(l)}for(var m=i.length-1;m>=0;m--)o.insertAdjacentElement("afterbegin",i[m])}},splitCoordinate:function(t,e,o){var i=[];t.split(/\s+/gim).forEach(M.parseNumber,i),this.push(i)},parseNumber:function(t,e,o){this.push(parseFloat(t))}},N=L.Control.extend({options:{position:"topleft"},onAdd:function(t){let e=L.DomUtil.create("div","mapml-reload-button leaflet-bar"),o=L.DomUtil.create("a","mapml-reload-button",e);return o.innerHTML="&#x021BA",o.href="#",o.title="Reload",o.setAttribute("role","button"),o.setAttribute("aria-label","Reload"),L.DomEvent.disableClickPropagation(o),L.DomEvent.on(o,"click",L.DomEvent.stop),L.DomEvent.on(o,"click",this._goReload,this),this._reloadButton=o,this._updateDisabled(),t.on("moveend",this._updateDisabled,this),e},onRemove:function(t){t.off("moveend",this._updateDisabled,this)},disable:function(){return this._disabled=!0,this._updateDisabled(),this},enable:function(){return this._disabled=!1,this._updateDisabled(),this},_goReload:function(t){!this._disabled&&this._map.options.mapEl._history.length>1&&this._map.options.mapEl.reload()},_updateDisabled:function(){setTimeout(()=>{L.DomUtil.removeClass(this._reloadButton,"leaflet-disabled"),this._reloadButton.setAttribute("aria-disabled","false"),this._map&&(this._disabled||this._map.options.mapEl._history.length<=1)&&(L.DomUtil.addClass(this._reloadButton,"leaflet-disabled"),this._reloadButton.setAttribute("aria-disabled","true"))},0)}}),q=function(t){return new N(t)},D=L.Layer.extend({onAdd:function(t){this._container=L.DomUtil.create("div","mapml-crosshair",t._container),this._container.innerHTML='<svg\n    xmlns:dc="http://purl.org/dc/elements/1.1/"\n    xmlns:cc="http://creativecommons.org/ns#"\n    xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"\n    xmlns:svg="http://www.w3.org/2000/svg"\n    xmlns="http://www.w3.org/2000/svg"\n    version="1.1"\n    x="0px"\n    y="0px"\n    viewBox="0 0 99.999998 99.999998"\n    xml:space="preserve">\n    <g><circle\n        r="3.9234731"\n        cy="50.21946"\n        cx="50.027821"\n        style="color:#000000;clip-rule:nonzero;display:inline;overflow:visible;isolation:auto;mix-blend-mode:normal;color-interpolation:sRGB;color-interpolation-filters:linearRGB;solid-color:#000000;solid-opacity:1;fill:#000000;fill-opacity:1;fill-rule:nonzero;stroke:#ffffff;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;stroke-miterlimit:4;stroke-dasharray:none;stroke-dashoffset:0;stroke-opacity:1;color-rendering:auto;image-rendering:auto;shape-rendering:auto;text-rendering:auto;enable-background:accumulate" /><path\n        d="m 4.9734042,54.423642 31.7671398,0 c 2.322349,0 4.204185,-1.881836 4.204185,-4.204185 0,-2.322349 -1.881836,-4.204184 -4.204185,-4.204184 l -31.7671398,0 c -2.3223489,-2.82e-4 -4.20418433,1.881554 -4.20418433,4.204184 0,2.322631 1.88183543,4.204185 4.20418433,4.204185 z"\n        style="color:#000000;clip-rule:nonzero;display:inline;overflow:visible;isolation:auto;mix-blend-mode:normal;color-interpolation:sRGB;color-interpolation-filters:linearRGB;solid-color:#000000;solid-opacity:1;fill:#000000;fill-opacity:1;fill-rule:nonzero;stroke:#ffffff;stroke-width:3;stroke-linecap:round;stroke-linejoin:round;stroke-miterlimit:4;stroke-dasharray:none;stroke-dashoffset:0;stroke-opacity:1;color-rendering:auto;image-rendering:auto;shape-rendering:auto;text-rendering:auto;enable-background:accumulate" /><path\n        d="m 54.232003,5.1650429 c 0,-2.3223489 -1.881836,-4.20418433 -4.204184,-4.20418433 -2.322349,0 -4.204185,1.88183543 -4.204185,4.20418433 l 0,31.7671401 c 0,2.322349 1.881836,4.204184 4.204185,4.204184 2.322348,0 4.204184,-1.881835 4.204184,-4.204184 l 0,-31.7671401 z"\n        style="fill:#000000;stroke:#ffffff;stroke-width:3;stroke-linecap:round;stroke-linejoin:round;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1;fill-opacity:1" /><path\n        d="m 99.287826,50.219457 c 0,-2.322349 -1.881835,-4.204184 -4.204184,-4.204184 l -31.76714,0 c -2.322349,0 -4.204184,1.881835 -4.204184,4.204184 0,2.322349 1.881835,4.204185 4.204184,4.204185 l 31.76714,0 c 2.320658,0 4.204184,-1.881836 4.204184,-4.204185 z"\n        style="color:#000000;clip-rule:nonzero;display:inline;overflow:visible;isolation:auto;mix-blend-mode:normal;color-interpolation:sRGB;color-interpolation-filters:linearRGB;solid-color:#000000;solid-opacity:1;fill:#000000;fill-opacity:1;fill-rule:nonzero;stroke:#ffffff;stroke-width:3;stroke-linecap:round;stroke-linejoin:round;stroke-miterlimit:4;stroke-dasharray:none;stroke-dashoffset:0;stroke-opacity:1;color-rendering:auto;image-rendering:auto;shape-rendering:auto;text-rendering:auto;enable-background:accumulate" /><path\n        d="m 45.823352,95.27359 c 0,2.322349 1.881836,4.204184 4.204185,4.204184 2.322349,0 4.204184,-1.881835 4.204184,-4.204184 l 0,-31.76714 c 0,-2.322349 -1.881835,-4.204185 -4.204184,-4.204185 -2.322349,0 -4.204185,1.881836 -4.204185,4.204185 l 0,31.76714 z"\n        style="color:#000000;clip-rule:nonzero;display:inline;overflow:visible;isolation:auto;mix-blend-mode:normal;color-interpolation:sRGB;color-interpolation-filters:linearRGB;solid-color:#000000;solid-opacity:1;fill:#000000;fill-opacity:1;fill-rule:nonzero;stroke:#ffffff;stroke-width:3;stroke-linecap:round;stroke-linejoin:round;stroke-miterlimit:4;stroke-dasharray:none;stroke-dashoffset:0;stroke-opacity:1;color-rendering:auto;image-rendering:auto;shape-rendering:auto;text-rendering:auto;enable-background:accumulate" /></g></svg>\n ',t.isFocused=!1,this._isQueryable=!1,t.on("layerchange layeradd layerremove overlayremove",this._toggleEvents,this),t.on("popupopen",this._isMapFocused,this),L.DomEvent.on(t._container,"keydown keyup mousedown",this._isMapFocused,this),this._addOrRemoveCrosshair()},onRemove:function(t){t.off("layerchange layeradd layerremove overlayremove",this._toggleEvents),t.off("popupopen",this._isMapFocused),L.DomEvent.off(t._container,"keydown keyup mousedown",this._isMapFocused)},_toggleEvents:function(){this._hasQueryableLayer()?this._map.on("viewreset move moveend",this._addOrRemoveCrosshair,this):this._map.off("viewreset move moveend",this._addOrRemoveCrosshair,this),this._addOrRemoveCrosshair()},_addOrRemoveCrosshair:function(t){this._hasQueryableLayer()?this._container.style.visibility=null:this._container.style.visibility="hidden"},_addOrRemoveMapOutline:function(t){let e=this._map._container;this._map.isFocused&&!this._outline?(this._outline=L.DomUtil.create("div","mapml-outline",e),this._outline.style.width=e.style.width,this._outline.style.height=e.style.height):!this._map.isFocused&&this._outline&&(L.DomUtil.remove(this._outline),delete this._outline)},_hasQueryableLayer:function(){let t=this._map.options.mapEl.layers;if(this._map.isFocused)for(let e of t)if(e.checked&&e._layer.queryable)return!0;return!1},_isMapFocused:function(t){this._map._container.parentNode.activeElement.classList.contains("leaflet-container")&&["keydown"].includes(t.type)&&t.shiftKey&&9===t.keyCode?this._map.isFocused=!1:this._map._container.parentNode.activeElement.classList.contains("leaflet-container")&&["keyup","keydown"].includes(t.type)?this._map.isFocused=!0:this._map.isFocused=!1,this._addOrRemoveMapOutline(),this._addOrRemoveCrosshair()}}),O=function(t){return new D(t)},R=L.Path.extend({options:{fillColor:"#2e91bf",color:"#ffffff",fill:!0,className:"mapml-marker",fillOpacity:1,weight:1},initialize:function(t,e){L.setOptions(this,e),this._latlng=L.latLng(t)},_project:function(){this._point=this._map.latLngToLayerPoint(this._latlng)},_update:function(){this._map&&this._path.setAttribute("d",this.defineMarker(this._point))},getLatLngs:function(){return this._latlng},getCenter:function(){return this._latlng},defineMarker:function(t){return`M${t.x} ${t.y} L${t.x-12.5} ${t.y-30} C${t.x-12.5} ${t.y-50}, ${t.x+12.5} ${t.y-50}, ${t.x+12.5} ${t.y-30} L${t.x} ${t.y}z`}}),j=function(t,e){return new R(t,e)};!function(n,a,E){var T={};n.M=T,T.detectImagePath=function(t){var e=L.DomUtil.create("div","leaflet-default-icon-path",t),o=L.DomUtil.getStyle(e,"background-image")||L.DomUtil.getStyle(e,"backgroundImage");return t.removeChild(e),o=null===o||0!==o.indexOf("url")?"":o.replace(/^url\(["']?/,"").replace(/marker-icon\.png["']?\)$/,"")},T.mime="text/mapml",T.WGS84=new L.Proj.CRS("EPSG:4326","+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs ",{origin:[-180,90],bounds:L.bounds([[-180,-90],[180,90]]),resolutions:[.703125,.3515625,.17578125,.087890625,.0439453125,.02197265625,.010986328125,.0054931640625,.00274658203125,.001373291015625,.0006866455078125,.0003433227539062,.0001716613769531,858306884766e-16,429153442383e-16,214576721191e-16,107288360596e-16,53644180298e-16,26822090149e-16,13411045074e-16,6.705522537e-7,3.352761269e-7],crs:{tcrs:{horizontal:{name:"x",min:0,max:t=>(T.WGS84.options.bounds.getSize().x/T.WGS84.options.resolutions[t]).toFixed()},vertical:{name:"y",min:0,max:t=>(T.WGS84.options.bounds.getSize().y/T.WGS84.options.resolutions[t]).toFixed()},bounds:t=>L.bounds([T.WGS84.options.crs.tcrs.horizontal.min,T.WGS84.options.crs.tcrs.vertical.min],[T.WGS84.options.crs.tcrs.horizontal.max(t),T.WGS84.options.crs.tcrs.vertical.max(t)])},pcrs:{horizontal:{name:"longitude",get min(){return T.WGS84.options.crs.gcrs.horizontal.min},get max(){return T.WGS84.options.crs.gcrs.horizontal.max}},vertical:{name:"latitude",get min(){return T.WGS84.options.crs.gcrs.vertical.min},get max(){return T.WGS84.options.crs.gcrs.vertical.max}},get bounds(){return T.WGS84.options.bounds}},gcrs:{horizontal:{name:"longitude",min:-180,max:180},vertical:{name:"latitude",min:-90,max:90},get bounds(){return L.latLngBounds([T.WGS84.options.crs.gcrs.vertical.min,T.WGS84.options.crs.gcrs.horizontal.min],[T.WGS84.options.crs.gcrs.vertical.max,T.WGS84.options.crs.gcrs.horizontal.max])}},map:{horizontal:{name:"i",min:0,max:t=>t.getSize().x},vertical:{name:"j",min:0,max:t=>t.getSize().y},bounds:t=>L.bounds(L.point([0,0]),t.getSize())},tile:{horizontal:{name:"i",min:0,max:256},vertical:{name:"j",min:0,max:256},get bounds(){return L.bounds([T.WGS84.options.crs.tile.horizontal.min,T.WGS84.options.crs.tile.vertical.min],[T.WGS84.options.crs.tile.horizontal.max,T.WGS84.options.crs.tile.vertical.max])}},tilematrix:{horizontal:{name:"column",min:0,max:t=>(T.WGS84.options.crs.tcrs.horizontal.max(t)/T.WGS84.options.crs.tile.bounds.getSize().x).toFixed()},vertical:{name:"row",min:0,max:t=>(T.WGS84.options.crs.tcrs.vertical.max(t)/T.WGS84.options.crs.tile.bounds.getSize().y).toFixed()},bounds:t=>L.bounds([T.WGS84.options.crs.tilematrix.horizontal.min,T.WGS84.options.crs.tilematrix.vertical.min],[T.WGS84.options.crs.tilematrix.horizontal.max(t),T.WGS84.options.crs.tilematrix.vertical.max(t)])}}}),T.CBMTILE=new L.Proj.CRS("EPSG:3978","+proj=lcc +lat_1=49 +lat_2=77 +lat_0=49 +lon_0=-95 +x_0=0 +y_0=0 +ellps=GRS80 +datum=NAD83 +units=m +no_defs",{origin:[-34655800,3931e4],bounds:L.bounds([[-34655800,-39e6],[1e7,3931e4]]),resolutions:[38364.660062653464,22489.62831258996,13229.193125052918,7937.5158750317505,4630.2175937685215,2645.8386250105837,1587.5031750063501,926.0435187537042,529.1677250021168,317.50063500127004,185.20870375074085,111.12522225044451,66.1459656252646,38.36466006265346,22.48962831258996,13.229193125052918,7.9375158750317505,4.6302175937685215,2.6458386250105836,1.5875031750063502,.9260435187537043,.5291677250021167,.31750063500127,.18520870375074083,.11112522225044451,.06614596562526459],crs:{tcrs:{horizontal:{name:"x",min:0,max:t=>(T.CBMTILE.options.bounds.getSize().x/T.CBMTILE.options.resolutions[t]).toFixed()},vertical:{name:"y",min:0,max:t=>(T.CBMTILE.options.bounds.getSize().y/T.CBMTILE.options.resolutions[t]).toFixed()},bounds:t=>L.bounds([T.CBMTILE.options.crs.tcrs.horizontal.min,T.CBMTILE.options.crs.tcrs.vertical.min],[T.CBMTILE.options.crs.tcrs.horizontal.max(t),T.CBMTILE.options.crs.tcrs.vertical.max(t)])},pcrs:{horizontal:{name:"easting",get min(){return T.CBMTILE.options.bounds.min.x},get max(){return T.CBMTILE.options.bounds.max.x}},vertical:{name:"northing",get min(){return T.CBMTILE.options.bounds.min.y},get max(){return T.CBMTILE.options.bounds.max.y}},get bounds(){return T.CBMTILE.options.bounds}},gcrs:{horizontal:{name:"longitude",min:-141.01,max:-47.74},vertical:{name:"latitude",min:40.04,max:86.46},get bounds(){return L.latLngBounds([T.CBMTILE.options.crs.gcrs.vertical.min,T.CBMTILE.options.crs.gcrs.horizontal.min],[T.CBMTILE.options.crs.gcrs.vertical.max,T.CBMTILE.options.crs.gcrs.horizontal.max])}},map:{horizontal:{name:"i",min:0,max:t=>t.getSize().x},vertical:{name:"j",min:0,max:t=>t.getSize().y},bounds:t=>L.bounds(L.point([0,0]),t.getSize())},tile:{horizontal:{name:"i",min:0,max:256},vertical:{name:"j",min:0,max:256},get bounds(){return L.bounds([T.CBMTILE.options.crs.tile.horizontal.min,T.CBMTILE.options.crs.tile.vertical.min],[T.CBMTILE.options.crs.tile.horizontal.max,T.CBMTILE.options.crs.tile.vertical.max])}},tilematrix:{horizontal:{name:"column",min:0,max:t=>(T.CBMTILE.options.crs.tcrs.horizontal.max(t)/T.CBMTILE.options.crs.tile.bounds.getSize().x).toFixed()},vertical:{name:"row",min:0,max:t=>(T.CBMTILE.options.crs.tcrs.vertical.max(t)/T.CBMTILE.options.crs.tile.bounds.getSize().y).toFixed()},bounds:t=>L.bounds([0,0],[T.CBMTILE.options.crs.tilematrix.horizontal.max(t),T.CBMTILE.options.crs.tilematrix.vertical.max(t)])}}}),T.APSTILE=new L.Proj.CRS("EPSG:5936","+proj=stere +lat_0=90 +lat_ts=50 +lon_0=-150 +k=0.994 +x_0=2000000 +y_0=2000000 +datum=WGS84 +units=m +no_defs",{origin:[-28567784.109255,32567784.109255],bounds:L.bounds([[-28567784.109254867,-28567784.109254755],[32567784.109255023,32567784.10925506]]),resolutions:[238810.813354,119405.406677,59702.7033384999,29851.3516692501,14925.675834625,7462.83791731252,3731.41895865639,1865.70947932806,932.854739664032,466.427369832148,233.213684916074,116.606842458037,58.3034212288862,29.1517106145754,14.5758553072877,7.28792765351156,3.64396382688807,1.82198191331174,.910990956788164,.45549547826179],crs:{tcrs:{horizontal:{name:"x",min:0,max:t=>(T.APSTILE.options.bounds.getSize().x/T.APSTILE.options.resolutions[t]).toFixed()},vertical:{name:"y",min:0,max:t=>(T.APSTILE.options.bounds.getSize().y/T.APSTILE.options.resolutions[t]).toFixed()},bounds:t=>L.bounds([T.APSTILE.options.crs.tcrs.horizontal.min,T.APSTILE.options.crs.tcrs.vertical.min],[T.APSTILE.options.crs.tcrs.horizontal.max(t),T.APSTILE.options.crs.tcrs.vertical.max(t)])},pcrs:{horizontal:{name:"easting",get min(){return T.APSTILE.options.bounds.min.x},get max(){return T.APSTILE.options.bounds.max.x}},vertical:{name:"northing",get min(){return T.APSTILE.options.bounds.min.y},get max(){return T.APSTILE.options.bounds.max.y}},get bounds(){return T.APSTILE.options.bounds}},gcrs:{horizontal:{name:"longitude",min:-180,max:180},vertical:{name:"latitude",min:60,max:90},get bounds(){return L.latLngBounds([T.APSTILE.options.crs.gcrs.vertical.min,T.APSTILE.options.crs.gcrs.horizontal.min],[T.APSTILE.options.crs.gcrs.vertical.max,T.APSTILE.options.crs.gcrs.horizontal.max])}},map:{horizontal:{name:"i",min:0,max:t=>t.getSize().x},vertical:{name:"j",min:0,max:t=>t.getSize().y},bounds:t=>L.bounds(L.point([0,0]),t.getSize())},tile:{horizontal:{name:"i",min:0,max:256},vertical:{name:"j",min:0,max:256},get bounds(){return L.bounds([T.APSTILE.options.crs.tile.horizontal.min,T.APSTILE.options.crs.tile.vertical.min],[T.APSTILE.options.crs.tile.horizontal.max,T.APSTILE.options.crs.tile.vertical.max])}},tilematrix:{horizontal:{name:"column",min:0,max:t=>(T.APSTILE.options.crs.tcrs.horizontal.max(t)/T.APSTILE.options.crs.tile.bounds.getSize().x).toFixed()},vertical:{name:"row",min:0,max:t=>(T.APSTILE.options.crs.tcrs.vertical.max(t)/T.APSTILE.options.crs.tile.bounds.getSize().y).toFixed()},bounds:t=>L.bounds([0,0],[T.APSTILE.options.crs.tilematrix.horizontal.max(t),T.APSTILE.options.crs.tilematrix.vertical.max(t)])}}}),T.OSMTILE=L.CRS.EPSG3857,L.setOptions(T.OSMTILE,{origin:[-20037508.342787,20037508.342787],bounds:L.bounds([[-20037508.342787,-20037508.342787],[20037508.342787,20037508.342787]]),resolutions:[156543.0339,78271.51695,39135.758475,19567.8792375,9783.93961875,4891.969809375,2445.9849046875,1222.9924523438,611.49622617188,305.74811308594,152.87405654297,76.437028271484,38.218514135742,19.109257067871,9.5546285339355,4.7773142669678,2.3886571334839,1.1943285667419,.59716428337097,.29858214168549,.14929107084274,.074645535421371,.03732276771068573,.018661383855342866,.009330691927671433],crs:{tcrs:{horizontal:{name:"x",min:0,max:t=>(T.OSMTILE.options.bounds.getSize().x/T.OSMTILE.options.resolutions[t]).toFixed()},vertical:{name:"y",min:0,max:t=>(T.OSMTILE.options.bounds.getSize().y/T.OSMTILE.options.resolutions[t]).toFixed()},bounds:t=>L.bounds([T.OSMTILE.options.crs.tcrs.horizontal.min,T.OSMTILE.options.crs.tcrs.vertical.min],[T.OSMTILE.options.crs.tcrs.horizontal.max(t),T.OSMTILE.options.crs.tcrs.vertical.max(t)])},pcrs:{horizontal:{name:"easting",get min(){return T.OSMTILE.options.bounds.min.x},get max(){return T.OSMTILE.options.bounds.max.x}},vertical:{name:"northing",get min(){return T.OSMTILE.options.bounds.min.y},get max(){return T.OSMTILE.options.bounds.max.y}},get bounds(){return T.OSMTILE.options.bounds}},gcrs:{horizontal:{name:"longitude",get min(){return T.OSMTILE.unproject(T.OSMTILE.options.bounds.min).lng},get max(){return T.OSMTILE.unproject(T.OSMTILE.options.bounds.max).lng}},vertical:{name:"latitude",get min(){return T.OSMTILE.unproject(T.OSMTILE.options.bounds.min).lat},get max(){return T.OSMTILE.unproject(T.OSMTILE.options.bounds.max).lat}},get bounds(){return L.latLngBounds([T.OSMTILE.options.crs.gcrs.vertical.min,T.OSMTILE.options.crs.gcrs.horizontal.min],[T.OSMTILE.options.crs.gcrs.vertical.max,T.OSMTILE.options.crs.gcrs.horizontal.max])}},map:{horizontal:{name:"i",min:0,max:t=>t.getSize().x},vertical:{name:"j",min:0,max:t=>t.getSize().y},bounds:t=>L.bounds(L.point([0,0]),t.getSize())},tile:{horizontal:{name:"i",min:0,max:256},vertical:{name:"j",min:0,max:256},get bounds(){return L.bounds([T.OSMTILE.options.crs.tile.horizontal.min,T.OSMTILE.options.crs.tile.vertical.min],[T.OSMTILE.options.crs.tile.horizontal.max,T.OSMTILE.options.crs.tile.vertical.max])}},tilematrix:{horizontal:{name:"column",min:0,max:t=>(T.OSMTILE.options.crs.tcrs.horizontal.max(t)/T.OSMTILE.options.crs.tile.bounds.getSize().x).toFixed()},vertical:{name:"row",min:0,max:t=>(T.OSMTILE.options.crs.tcrs.vertical.max(t)/T.OSMTILE.options.crs.tile.bounds.getSize().y).toFixed()},bounds:t=>L.bounds([0,0],[T.OSMTILE.options.crs.tilematrix.horizontal.max(t),T.OSMTILE.options.crs.tilematrix.vertical.max(t)])}}}),T.convertPCRSBounds=P.convertPCRSBounds,T.axisToXY=P.axisToXY,T.csToAxes=P.csToAxes,T.convertAndFormatPCRS=P.convertAndFormatPCRS,T.axisToCS=P.axisToCS,T.parseNumber=P.parseNumber,T.extractInputBounds=P.extractInputBounds,T.splitCoordinate=P.splitCoordinate,T.boundsToPCRSBounds=P.boundsToPCRSBounds,T.pixelToPCRSBounds=P.pixelToPCRSBounds,T.metaContentToObject=P.metaContentToObject,T.coordsToArray=P.coordsToArray,T.parseStylesheetAsHTML=P.parseStylesheetAsHTML,T.QueryHandler=I,T.ContextMenu=B,L.Map.addInitHook("addHandler","query",T.QueryHandler),L.Map.addInitHook("addHandler","contextMenu",T.ContextMenu),T.MapMLLayer=f,T.mapMLLayer=x,T.ImageOverlay=g,T.imageOverlay=_,T.TemplatedImageLayer=d,T.templatedImageLayer=y,T.TemplatedFeaturesLayer=p,T.templatedFeaturesLayer=h,T.TemplatedLayer=u,T.templatedLayer=c,T.TemplatedTileLayer=l,T.templatedTileLayer=m,T.MapMLFeatures=s,T.mapMlFeatures=r,T.MapMLLayerControl=o,T.mapMlLayerControl=i,T.ReloadButton=N,T.reloadButton=q,T.MapMLStaticTileLayer=t,T.mapMLStaticTileLayer=e,T.DebugOverlay=b,T.debugOverlay=v,T.Crosshair=D,T.crosshair=O,T.SVGMarker=R,T.svgMarker=j}(window)}();